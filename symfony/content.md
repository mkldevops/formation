name: inverse
class: center, middle, inverse
# Symfony Framework
# .red[PHP 8]
<div class="logo"><svg class="logo-1" fill="white" width="196" height="64" viewBox="0 0 196 64" style="fill-rule: evenodd; clip-rule: evenodd; stroke-linejoin: round; stroke-miterlimit: 2;"><g transform="matrix(0.101031,0,0,0.101031,2.39526,-0.329946)"><g transform="matrix(1.27705,0,0,1.27705,1143.65,155.404)"><path d="M320.958,94.576C320.958,107.301 317.357,117.884 310.155,126.323C302.952,134.763 293.386,140.971 281.456,144.947L331.695,223.685L290.072,223.685L246.727,150.647L230.025,150.647L230.025,223.685L193.837,223.685L193.837,40.361L247.787,40.361C296.568,40.361 320.958,58.433 320.958,94.576ZM283.312,94.576C283.312,84.855 280.462,77.764 274.762,73.301C269.062,68.838 260.38,66.607 248.715,66.607L230.025,66.607L230.025,124.931L249.908,124.931C260.954,124.931 269.283,122.501 274.895,117.641C280.506,112.78 283.312,105.092 283.312,94.576Z" style="fill-rule: nonzero;"></path></g><g transform="matrix(1.27705,0,0,1.27705,1486.87,208.548)"><path d="M313.005,64.751L241.159,227.264L208.153,217.058L277.612,67.402L195.163,67.402L195.163,40.361L313.005,40.361L313.005,64.751Z" style="fill-rule: nonzero;"></path></g><g transform="matrix(1.27705,0,0,1.27705,1335.53,155.404)"><path d="M253.752,12.524C257.994,12.524 261.75,13.43 265.019,15.241C268.289,17.053 270.852,19.55 272.708,22.731C274.563,25.912 275.491,29.447 275.491,33.335C275.491,37.224 274.563,40.758 272.708,43.94C270.852,47.121 268.289,49.64 265.019,51.495C261.75,53.351 257.994,54.279 253.752,54.279C249.51,54.279 245.733,53.351 242.419,51.495C239.105,49.64 236.52,47.121 234.664,43.94C232.808,40.758 231.88,37.224 231.88,33.335C231.88,29.447 232.808,25.912 234.664,22.731C236.52,19.55 239.105,17.053 242.419,15.241C245.733,13.43 249.51,12.524 253.752,12.524ZM201.658,83.309L276.419,83.309L276.419,198.897L313.402,198.897L313.402,223.685L200.332,223.685L200.332,198.897L241.424,198.897L241.424,108.097L201.658,108.097L201.658,83.309Z" style="fill-rule: nonzero;"></path></g><g transform="matrix(2.01117,0,0,2.01117,165.834,-128.735)"><path d="M261.043,177.319L211.622,177.319L211.622,218.681L254.382,218.681L254.382,228.302L211.622,228.302L211.622,271.803L264.332,271.803L264.332,280.93L201.096,280.93L201.096,167.944L262.441,167.944L261.043,177.319ZM213.76,150.758L245.501,134.23L250.682,143.851L216.72,156.432L213.76,150.758Z" style="fill-rule: nonzero;"></path></g><g transform="matrix(2.01117,0,0,2.01117,165.834,-128.735)"><path d="M312.861,273.201C321.248,273.201 329.06,270.651 336.297,265.553L341.642,272.46C337.969,275.53 333.501,277.984 328.238,279.82C322.975,281.657 317.987,282.575 313.272,282.575C304.994,282.575 297.922,280.766 292.056,277.148C286.191,273.529 281.723,268.376 278.653,261.688C275.583,255 274.048,247.133 274.048,238.088C274.048,229.426 275.583,221.696 278.653,214.898C281.723,208.101 286.218,202.756 292.139,198.863C298.059,194.971 305.131,193.025 313.354,193.025C323.935,193.025 333.282,196.287 341.395,202.81L335.968,210.129C328.128,204.757 320.426,202.07 312.861,202.07C307.488,202.07 302.733,203.441 298.594,206.182C294.455,208.923 291.22,212.993 288.89,218.393C286.561,223.793 285.396,230.358 285.396,238.088C285.396,245.927 286.547,252.465 288.849,257.7C291.152,262.935 294.373,266.828 298.512,269.377C302.65,271.926 307.434,273.201 312.861,273.201Z" style="fill-rule: nonzero;"></path></g><g transform="matrix(2.01117,0,0,2.01117,165.834,-128.735)"><path d="M386.388,193.025C394.118,193.025 400.641,194.834 405.959,198.452C411.277,202.07 415.251,207.224 417.883,213.912C420.514,220.6 421.83,228.549 421.83,237.759C421.83,246.421 420.473,254.137 417.759,260.907C415.046,267.677 411.003,272.981 405.63,276.819C400.258,280.656 393.761,282.575 386.141,282.575C378.412,282.575 371.874,280.725 366.529,277.024C361.184,273.324 357.168,268.13 354.482,261.441C351.796,254.753 350.453,246.914 350.453,237.923C350.453,228.987 351.81,221.148 354.523,214.405C357.237,207.662 361.294,202.413 366.694,198.658C372.093,194.903 378.658,193.025 386.388,193.025ZM386.388,201.988C369.887,201.988 361.636,213.967 361.636,237.923C361.636,261.661 369.805,273.529 386.141,273.529C402.478,273.529 410.646,261.606 410.646,237.759C410.646,213.912 402.56,201.988 386.388,201.988Z" style="fill-rule: nonzero;"></path></g><g transform="matrix(2.01117,0,0,2.01117,165.834,-128.735)"><path d="M463.945,261.359C463.945,265.635 465.301,268.76 468.015,270.734C470.729,272.707 474.443,273.694 479.157,273.694C483.982,273.694 489.053,272.652 494.37,270.569L497.33,278.463C494.973,279.669 492.136,280.656 488.82,281.424C485.503,282.191 481.953,282.575 478.171,282.575C473.566,282.575 469.413,281.739 465.713,280.067C462.012,278.395 459.093,275.955 456.955,272.748C454.817,269.541 453.748,265.745 453.748,261.359L453.748,168.52L426.94,168.52L426.94,159.639L463.945,159.639L463.945,261.359Z" style="fill-rule: nonzero;"></path></g><g transform="matrix(2.01117,0,0,2.01117,165.834,-128.735)"><path d="M520.121,241.87C520.231,248.833 521.491,254.657 523.904,259.345C526.316,264.032 529.509,267.513 533.483,269.788C537.458,272.063 541.885,273.201 546.764,273.201C551.15,273.201 555.11,272.57 558.646,271.309C562.182,270.048 565.979,268.02 570.035,265.224L575.38,272.872C571.433,275.942 566.952,278.326 561.936,280.026C556.919,281.725 551.999,282.575 547.175,282.575C539.336,282.575 532.552,280.725 526.823,277.024C521.094,273.324 516.722,268.102 513.707,261.359C510.692,254.616 509.184,246.777 509.184,237.841C509.184,229.125 510.705,221.381 513.748,214.611C516.791,207.84 521.08,202.55 526.617,198.74C532.154,194.93 538.486,193.025 545.613,193.025C552.52,193.025 558.496,194.711 563.539,198.082C568.583,201.454 572.434,206.278 575.093,212.555C577.751,218.832 579.081,226.246 579.081,234.798C579.081,236.059 578.999,238.417 578.834,241.87L520.121,241.87ZM545.859,202.564C541.09,202.564 536.855,203.674 533.155,205.894C529.454,208.114 526.48,211.472 524.232,215.967C521.985,220.463 520.669,226.027 520.285,232.66L569.377,232.66C569.158,222.793 566.938,215.31 562.717,210.211C558.496,205.113 552.876,202.564 545.859,202.564Z" style="fill-rule: nonzero;"></path></g><path d="M250.428,75.558C385.339,75.558 494.87,185.089 494.87,320C494.87,454.911 385.339,564.442 250.428,564.442C115.517,564.442 5.986,454.911 5.986,320C5.986,185.089 115.517,75.558 250.428,75.558ZM131.233,450.023L131.233,203.31L220.202,205.493C297.709,207.676 311.355,209.314 331.55,219.685C400.87,255.709 417.79,343.587 365.937,402.536L344.65,426.552L356.658,438.014L368.12,450.023L256.772,450.023L256.772,339.22L269.872,351.228L282.972,363.782L294.434,352.32C308.08,338.674 309.171,325.575 297.163,309.2C294.835,305.797 292.624,303.334 289.625,301.561C283.483,297.931 274.034,297.192 253.497,297.192L218.564,297.192L218.564,450.023L131.233,450.023Z"></path></g></svg></div>

---

class: middle
.left-column[
### Objectif
]
.right-column[

  **La formation Symfony** est destin√©e aux d√©veloppeurs qui souhaitent am√©liorer leurs comp√©tences en mati√®re de d√©veloppement web. Elle vise √† fournir aux participants une compr√©hension approfondie du framework Symfony, ainsi qu'√† leur donner les connaissances et les comp√©tences n√©cessaires pour cr√©er des applications web de qualit√© sup√©rieure.

### üßó 
Au cours de la formation, les participants apprendront comment utiliser les diff√©rents composants de Symfony pour construire des applications web robustes et √©volutives. Ils d√©couvriront √©galement comment travailler avec les diff√©rents mod√®les de donn√©es, comment g√©rer les utilisateurs et les autorisations, et comment impl√©menter des fonctionnalit√©s avanc√©es telles que les formulaires, les validations, les routes, les contr√¥leurs, les vues, etc.

### ü§ù 
En outre, la formation permettra aux participants de d√©velopper leur capacit√© √† travailler en √©quipe, √† communiquer avec d'autres d√©veloppeurs et √† g√©rer les d√©fis du d√©veloppement web. Les participants auront √©galement l'opportunit√© de mettre en pratique leurs comp√©tences en travaillant sur des projets concrets.

### üòé 
En somme, la formation Symfony est une occasion unique pour les d√©veloppeurs de d√©velopper leurs comp√©tences en d√©veloppement web et de se faire remarquer sur le march√© du travail. Les participants auront les outils et les connaissances n√©cessaires pour construire des applications web performantes et pour atteindre leurs objectifs professionnels.
]

---

class: middle
.left-column[
### Objectif
### Au programme
]
.right-column[
#### **Installation de notre environnement**
  - Gitpod / Codespace (github)
  - Docker
  - Un environement docker avec 
      - PHP 8.2
      - Composer
      - Nodejs
      - Symfony cli

#### **Symfony 6**
  - Nouveau projet symfony 6.2
  - Postgresql
  - Environnement de dev
  - Entit√©, Controller, Event
  - Messages
  - Redis
]

---
class: center, middle, inverse
# 1. Environnement de travail
---

.left-column[
### Editeur en ligne
]
.right-column[

### **Avantages de l'utilisation d'√©diteurs de code en ligne pour la formation Symfony**
* Acc√®s depuis n'importe o√π, √† tout moment
* Interface utilisateur conviviale
* Fonctionnalit√©s de collaboration en temps r√©el
* Int√©gration transparente avec des services tels que Git
* Exp√©rience de d√©veloppement uniforme pour tous les participants
* Possibilit√© de se concentrer sur le d√©veloppement des comp√©tences
* Acc√®s aux m√™mes outils et fonctionnalit√©s pour tous les participants
* Facilitation de la collaboration en √©quipe et du partage de connaissances

En utilisant des √©diteurs de code en ligne pour la formation Symfony, vous b√©n√©ficierez d'une exp√©rience plus souple et plus facile, tout en garantissant une exp√©rience de d√©veloppement uniforme pour tous les participants.

### **Liens** 
  * gitpod (https://gitpod.io/projects)
  * codespace (https://github.com/codespaces)
]

---

.left-column[
### Editeur en ligne
### Mise en place
]
.right-column[
#### **Utilisation d'√©diteurs de code en ligne pour la formation Symfony**
Pendant cette formation, nous privil√©gierons l'utilisation de Gitpod. Pour pouvoir en b√©n√©ficier, vous devrez disposer d'un nouveau d√©p√¥t Git existant (sur Github, Gitlab ou Bitbucket).

Gitpod embarque une image par d√©faut accessible √† partir de https://hub.docker.com/r/gitpod/workspace-full. Toutefois, il est possible de personnaliser votre environnement de d√©veloppement en configurant, par exemple, les extensions de PHP.

Pour sp√©cifier l'utilisation d'une image Docker √† partir d'un fichier **Dockerfile**, il est n√©cessaire d'ajouter un fichier `.gitpod.yml` √† la racine du projet avec le contenu suivant :
```yml
image:
    file: .gitpod.Dockerfile
```
]

---

.left-column[
### Editeur en ligne
### Mise en place
]
.right-column[
Ensuite, il faut cr√©er un fichier nomm√© `.gitpod.Dockerfile` √† la racine du projet et y ajouter le contenu suivant :
```dockerfile
FROM gitpod/workspace-full:latest

RUN sudo apt update
RUN sudo apt install -y apt-utils apt-transport-https postgresql postgresql-contrib
RUN sudo install-packages php-intl php-redis php-amqp php-pdo_pgsql

RUN curl -1sLf 'https://dl.cloudsmith.io/public/symfony/stable/setup.deb.sh' | sudo -E bash
RUN sudo apt install symfony-cli
```

Ce fichier **Dockerfile** sp√©cifie l'utilisation de l'image de base `gitpod/workspace-full` et installe des paquets suppl√©mentaires n√©cessaires, tels que `php-intl`, `php-redis` et `php-amqp`. Il installe √©galement `apt-utils` et `apt-transport-https` pour la gestion des paquets, et installe `symfony-cli` en utilisant les scripts d'installation fournis par Symfony. Bien s√ªr, le contenu de ce fichier peut √™tre modifi√© en fonction des besoins sp√©cifiques de chaque projet.

Puis, committez et poussez ces deux fichiers sur votre branche principale.

Rendez-vous sur https://gitpod.io, puis sur l'onglet "Project", cliquez sur "New Project". Choisissez le r√©pertoire git pr√©alablement configur√©.

Assurez-vous de suivre ces √©tapes pour vous pr√©parer √† utiliser l'√©diteur de code en ligne pour la formation Symfony.
]

---

.left-column[
### Editeur en ligne
### Mise en place
### Verification
]
.right-column[
#### **Pr√©paration pour la formation**
* Sur l'√©diteur de code en ligne, certains logiciels sont d√©j√† install√©s.
* V√©rifions que nous avons tous les outils n√©cessaires pour cette formation.

Assurez-vous de v√©rifier les outils n√©cessaires avant de commencer la formation avec un √©diteur de code en ligne.

| .red[software] | .red[command version] | .red[version] |
|--|--|
| **docker** | `docker --version` | +20.10 |
| **docker compose** | `docker compose version` | +2.10 |
| **php** | `php -version` | +8.1 |
| **composer** | `composer -version` | +2.4 |
| **node** | `node -version` | +16 |
| **yarn** | `yarn -version` | +1.22 |
]

---

.left-column[
### Editeur en ligne
### Mise en place
### Verification
### Initialisation
]
.right-column[

### **Initialisation du projet avec Symfony**
* Nous allons initialiser le projet avec le client Symfony.
* Nous utiliserons la **version 6.2**, la derni√®re en date.
* Nous utiliserons √©galement **PHP 8.1+**.

Assurez-vous de suivre ces √©tapes pour initialiser correctement votre projet avec Symfony en utilisant les derni√®res versions disponibles.

Lancer la commande suivante depuis le terminal, elle va permettre de cloner symfony-skeleton, lancer composer ...
‚ùó Assurez-vous que le repertoire en cours soit vide.
```sh
symfony new --dir=guestbook --webapp --version=6.2
cd guestbook
rm -rf .git
```
* **`new`** L'argument permet de construire un nouveau projet
* **`--dir=guestbook`** repertoire d'installation du projet symfony
* **`--webapp`** L'option installe tous les paquets dont vous avez g√©n√©ralement besoin pour cr√©er des applications Web.

Le binaire symfony fournit √©galement un outil permettant de v√©rifier si votre ordinateur r√©pond √† toutes les exigences. Ouvrez votre terminal de console et ex√©cutez cette commande :
```sh
symfony book:check-requirements
```
]

---

.left-column[
### Editeur en ligne
### Mise en place
### Verification
### Initialisation
### VsCode Extensions
]
.right-column[

Nous aurons besoin de certaines extension sur Vscode pour travailler correctement et facilement.

Liste des extensions
- PHP Debug
- PHP Intelephense
- PHP Namespace Resolver
- DotENV
- YAML
- PHP 8 Getter & Setter
- Extension Twig Language 2
]

---
class: center, middle, inverse
# 2. En route vers symfony 6
https://symfony.com/doc/current/the-fast-track/fr/index.html
---


### .center[Pr√©sentation du projet]
Nous devons trouver un projet sur lequel travailler. C'est un certain d√©fi car nous devons choisir un projet assez vaste pour couvrir compl√®tement Symfony, mais en m√™me temps, il devrait √™tre assez petit ; Afin que vous ne vous ennuyiez pas √† impl√©menter des fonctionnalit√©s similaires plusieurs fois.

#### Description du projet
Le projet a pour but d'obtenir un retour d'exp√©rience sur les conf√©rences : une liste des conf√©rences sur la page d'accueil ainsi qu'une page pour chacune d'entre elles, pleine de commentaires sympathiques. Un commentaire est compos√© d'un petit texte et d'une photo, optionnelle, prise pendant la conf√©rence.

Le projet comprendra plusieurs applications : une application web traditionnelle avec une interface HTML, une API et une SPA pour les t√©l√©phones mobiles.
#### La ma√Ætrise s‚Äôacquiert par la pratique
La ma√Ætrise s‚Äôacquiert par la pratique. Point final. Lire un livre sur Symfony, c'est bien. Coder une application sur votre ordinateur tout en lisant un livre sur Symfony, c'est encore mieux. Cette formation est tr√®s sp√©cial puisque tout a √©t√© fait pour que vous puissiez suivre et  coder.

#### R√©cup√©rer le code source du projet
Clonez [le d√©p√¥t du livre](https://github.com/the-fast-track/book-6.2-1) d'or quelque part sur votre machine :
```sh
symfony new --version=6.2-1 --book guestbook
```

---

.left-column[
### A. Structure
]
.right-column[

Comme Git est install√© sur notre machine, `symfony new` nous a √©galement cr√©√© un d√©p√¥t Git, dans lequel a √©t√© ajout√© le tout premier commit.

Jetons un coup d'oeil √† la structure des r√©pertoires :
```
‚îú‚îÄ‚îÄ bin/
‚îú‚îÄ‚îÄ composer.json
‚îú‚îÄ‚îÄ composer.lock
‚îú‚îÄ‚îÄ config/
‚îú‚îÄ‚îÄ public/
‚îú‚îÄ‚îÄ src/
‚îú‚îÄ‚îÄ symfony.lock
‚îú‚îÄ‚îÄ var/
‚îî‚îÄ‚îÄ vendor/
```
* Le r√©pertoire **`bin/`** contient le principal point d'entr√©e de la ligne de commande : `console`. Vous l'utiliserez tout le temps.

* Le r√©pertoire **`config/`** est constitu√© d'un ensemble de fichiers de configuration sensibles, initialis√©s avec des valeurs par d√©faut. Un fichier par paquet. Vous les modifierez rarement : faire confiance aux valeurs par d√©faut est presque toujours une bonne id√©e.

* Le r√©pertoire **`public/`** est le r√©pertoire racine du site web, et le script index.php est le point d'entr√©e principal de toutes les ressources HTTP dynamiques.

]
---

.left-column[
### A. Structure

]
.right-column[
* Le r√©pertoire **`src/`** h√©berge tout le code que vous allez √©crire ; c'est ici que vous passerez la plupart de votre temps. Par d√©faut, toutes les classes de ce r√©pertoire utilisent le namespace PHP App. C'est votre r√©pertoire de travail, votre code, votre logique de domaine. Symfony n'a pas grand-chose √† y faire.

* Le r√©pertoire **`var/`** contient les caches, les logs et les fichiers g√©n√©r√©s par l'application lors de son ex√©cution. Vous pouvez le laisser tranquille. C'est le seul r√©pertoire qui doit √™tre en √©criture en production.

* Le r√©pertoire **`vendor/`** contient tous les paquets install√©s par Composer, y compris Symfony lui-m√™me. C'est notre arme secr√®te pour un maximum de productivit√©. Ne r√©inventons pas la roue. Vous profiterez des biblioth√®ques existantes pour vous faciliter le travail. Le r√©pertoire est g√©r√© par Composer. N'y touchez jamais.

C'est tout ce que vous avez besoin de savoir pour l'instant. üèÅ

> üì¨ Commitez notre travail via `git commit .`

]

---

.left-column[
### A. Structure
### B. Resources publique
]
.right-column[
#### Cr√©er des ressources publiques
Tout ce qui se trouve dans le r√©pertoire **`public/`** est accessible par un navigateur. Par exemple, si vous d√©placez votre fichier GIF anim√© (nommez-le under-construction.gif) dans un nouveau r√©pertoire `public/images/`, il sera alors disponible √† une URL comme https://localhost/images/under-construction.gif.

T√©l√©chargez mon image GIF ici :
```sh
mkdir public/images/
php -r "copy('http://clipartmag.com/images/website-under-construction-image-6.gif', 'public/images/under-construction.gif');"
```
]

---

.left-column[
### A. Structure
### B. Resources publique
### C. Serveur symfony
]
.right-column[
####¬†Lancer un serveur web local
La commande symfony inclut un serveur web optimis√© pour le d√©veloppement. Comme vous vous en doutez, il marche tr√®s bien avec Symfony. Cependant, ne l'utilisez jamais en production.

√Ä partir du r√©pertoire du projet, d√©marrez le serveur web en arri√®re-plan (option -d) :
```sh
symfony server:start -d
```

depuis l'√©diteur en ligne vous pouvez retrouver le lien de notre serveur lanc√© sur l'onglet `PORTS`. Choisissez le port 8000, un nouvel onglet s'ouvre affichant une page "welcome to symfony"
> üóí Pour r√©soudre les probl√®mes, ex√©cutez `symfony server:log` ; cette commande affiche les derniers logs de votre serveur web, de PHP et de votre application.

Naviguez vers `/images/under-construction.gif.` Pour percevoir notre image anim√© sur notre projet symfony.

> üì¨ Commitez notre travail via `git commit .`
]


---

.left-column[
### A. Structure
### B. Resources publique
### C. Serveur symfony
### D. Diagnostiquer
]
.right-column[
Mettre en place un projet, c'est aussi avoir les bons outils pour d√©boguer les probl√®mes. Fort heureusement, des assistants tr√®s utiles sont inclus avec le paquet webapp.

#### D√©couvrir les outils de d√©bogage de Symfony
Pour commencer, le Symfony Profiler vous fait gagner un temps fou lorsque vous avez besoin de trouver l'origine d'un probl√®me.

Si vous regardez la page d'accueil

.center[![Debug page](img/debug-page.png)]

Ce n'est qu'une page de remplissage, car nous n'avons toujours pas d√©fini de page d'accueil. M√™me si la page par d√©faut qui vous accueille est belle, c'est une page d'erreur **`404`**.
]

---

.left-column[
### A. Structure
### B. Resources publique
### C. Serveur symfony
### D. Diagnostiquer
]
.right-column[

Si vous vous rendez sur la route `/_profiler` puis la premi√®re ligne avce le code **`404`**, vous obtenez le "vrai" message d'exception dans les logs du *Symfony Profiler*.

.center[![Symfony profiler](img/symfony-profiler.png)]

Les logs sont √©galement tr√®s utiles dans les sessions de d√©bogage. Symfony a une commande pratique pour consulter tous les logs (du serveur web, de PHP et de votre application) :
```sh
symfony server:log
```
]

---

.left-column[
### A. Structure
### B. Resources publique
### C. Serveur symfony
### D. Diagnostiquer
### E. Les environemments
]
.right-column[

#### Comprendre les environnements Symfony
Comme le Symfony Profiler n'est utile que pendant le d√©veloppement, nous voulons √©viter qu'il soit install√© en production. Par d√©faut, Symfony ne l'installe que pour les environnements de dev et de test.

Symfony int√®gre une notion d'environnement. Par d√©faut, il y en a trois, mais vous pouvez en ajouter autant que vous le souhaitez : `dev`, `prod` et `test`. Tous les environnements partagent le m√™me code, mais ils repr√©sentent des configurations diff√©rentes.

Par exemple, tous les outils de d√©bogage sont activ√©s en environnement de `dev`. Dans celui de `prod`, l'application est optimis√©e pour la performance.

Basculer d'un environnement √† l'autre peut se faire en changeant la variable d'environnement `APP_ENV`.

#### G√©rer la configuration des environnements
`APP_ENV` peut √™tre d√©fini en utilisant des variables d'environnement "r√©elles" depuis votre terminal : `export APP_ENV=dev`

Essayez de modifier la valeur de la variable `APP_ENV` √† "prod", redemarrez le serveur symfony, puis rendez-vous sur la page du profiler qui n'est disponible qu'en environnement de d√©veloppement.

Pour supprimer notre variable d'environnement, vous pouvez utiliser la commande `unset APP_ENV` dans un terminal
]

---

.left-column[
### A. Structure
### B. Resources publique
### C. Serveur symfony
### D. Diagnostiquer
### E. Les environemments
]
.right-column[
L'utilisation de variables d'environnement r√©elles est la meilleure fa√ßon de d√©finir des valeurs comme `APP_ENV` en production. Mais sur les machines de d√©veloppement, avoir √† d√©finir beaucoup de variables d'environnement peut s'av√©rer fastidieux. D√©finissez-les plut√¥t dans un fichier `.env.`

Un fichier sensible `.env` a √©t√© g√©n√©r√© automatiquement pour vous lorsque le projet a √©t√© cr√©√© :
```sh
###> symfony/framework-bundle ###
APP_ENV=dev
APP_SECRET=76f040716bf0a94fa2409642b1883e55
###< symfony/framework-bundle ###
```
> üí° N'importe quel paquet peut ajouter plus de variables d'environnement √† ce fichier gr√¢ce √† leur [recette utilis√©e par Symfony Flex](https://github.com/symfony/recipes).

Le fichier .env est commit√© sur le d√©p√¥t Git et liste les valeurs par d√©faut de la production. Vous pouvez surcharger ces valeurs en cr√©ant un fichier .env.local. Ce fichier ne doit pas √™tre commit√© : c'est pourquoi le fichier .gitignore l'ignore d√©j√†.

Ne stockez jamais des donn√©es secr√®tes ou sensibles dans ces fichiers. Nous verrons comment g√©rer ces donn√©es sensibles dans une autre √©tape.
]

---
class: center, middle, inverse
# 3. Notre premi√®re route
---

.left-column[
  ### A. Contr√¥leur
  ##### Maker bundle
]
.right-column[
La page d'accueil est une ennuyeuse page d'erreur 404. Corrigeons cela.

Lorsqu'une requ√™te HTTP arrive au serveur, comme pour notre page d'accueil (http://localhost:8000/), **Symfony** essaie de trouver une route qui corresponde au chemin de la requ√™te (`/` ici). Une route est le lien entre le chemin de la requ√™te et un callable PHP, une fonction devant cr√©er la r√©ponse HTTP associ√©e √† cette requ√™te.

Ces callables sont nomm√©s **"contr√¥leurs"**. Dans Symfony, la plupart des contr√¥leurs sont impl√©ment√©s sous la forme de classes PHP. Vous pouvez cr√©er ces classes manuellement, mais comme nous aimons aller vite, voyons comment Symfony peut nous aider.

#### Se faciliter la vie avec le Maker Bundle
Pour g√©n√©rer des contr√¥leurs facilement, nous pouvons utiliser le paquet `symfony/maker-bundle`, qui a √©t√© install√© en tant que composant du paquet `webapp`.

**Le Maker Bundle** vous permet de g√©n√©rer un grand nombre de classes diff√©rentes. Nous l'utiliserons constamment dans cette formation. Chaque **"g√©n√©rateur"** correspond √† une commande et chacune d'entre elles appartient au m√™me namespace `make`.

La commande `list`, int√©gr√©e nativement √† la console symfony, permet d'afficher toutes les commandes disponibles sous un namespace donn√©. Utilisez-la pour d√©couvrir les g√©n√©rateurs fournis par **Maker Bundle** :
```sh
symfony console list make
```
]

---

.left-column[
  ### A. Contr√¥leur
  #### Maker bundle
  #### G√©n√©rer un contr√¥leur
]
.right-column[
#### G√©n√©rer un contr√¥leur
Cr√©ez votre premier Controller avec la commande `make:controller` :
```sh
symfony console make:controller ConferenceController
```
La commande cr√©e une classe `ConferenceController` dans le r√©pertoire `src/Controller/`. La classe g√©n√©r√©e contient du code standard pr√™t √† √™tre ajust√© :
    
```php
# src/Controller/ConferenceController.php
namespace App\Controller;

use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\Routing\Annotation\Route;

class ConferenceController extends AbstractController
{
    #[Route('/conference', name: 'conference')]
    public function index(): Response
    {
        return $this->render('conference/index.html.twig', [
            'controller_name' => 'ConferenceController',
        ]);
    }
}
```

> üì¨ Commitez notre travail via `git commit .`
]

---

.left-column[
  ### A. Contr√¥leur
  #### Maker bundle
  #### G√©n√©rer un contr√¥leur
  #### Personnaliser la route
]

.right-column[
L'attribut `#[Route('/conference', name: 'conference')]` est ce qui fait de la m√©thode `index()` un contr√¥leur (la configuration est √† c√¥t√© du code qu'elle configure).

Lorsque vous visitez la page `/conference` dans un navigateur, le contr√¥leur est ex√©cut√© et une r√©ponse est renvoy√©e.


Modifiez la route afin qu'elle corresponde √† la page d'accueil (`/`) :

```diff
class ConferenceController extends AbstractController
{
-   #[Route('/conference', name: 'app_conference')]
+   #[Route('/', name: 'homepage')]
    public function index(): Response
    {
```

Le nom de la route (`name`) sera utile lorsque nous voudrons faire r√©f√©rence √† la page d'accueil dans notre code. Au lieu de coder en dur le chemin `/`, nous utiliserons le nom de la route. √Ä la place de la page par d√©faut, retournons une simple page HTML :
```diff
     public function index(): Response
     {
-        return $this->render('conference/index.html.twig', [
-            'controller_name' => 'ConferenceController',
-        ]);
+        return new Response(<<<EOF
+            <html>
+                <body><img src="/images/under-construction.gif" /></body>
+            </html>
+        EOF);
     }
```
]

---

.left-column[
  ### A. Contr√¥leur
  #### Maker bundle
  #### G√©n√©rer un contr√¥leur
  #### Personnaliser la route
]

.right-column[
Rafra√Æchissez le navigateur :

![Symfony Contr√¥leur](img/symfony-controleur.png)

La responsabilit√© principale d'un contr√¥leur est de retourner une r√©ponse **HTTP** (Response) pour la requ√™te.

> üì¨ Commitez notre travail via `git commit .`
]

---

.left-column[
  ### A. Contr√¥leur
  #### Maker bundle
  #### G√©n√©rer un contr√¥leur
  #### Personnaliser la route
  #### Ajouter un easter egg
]

.right-column[
#### Ajouter un easter egg
Pour montrer comment une r√©ponse peut tirer parti de l'information contenue dans la requ√™te, ajoutons un petit easter egg. Lorsqu'une requ√™te vers la page d'accueil sera r√©alis√©e avec un param√®tre d'URL comme `?hello=Fabien`, nous ajouterons du texte pour saluer la personne :

```diff
 namespace App\Controller;

 use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
+use Symfony\Component\HttpFoundation\Request;
 use Symfony\Component\HttpFoundation\Response;
 use Symfony\Component\Routing\Annotation\Route;

 class ConferenceController extends AbstractController
 {
     #[Route('/', name: 'homepage')]
-    public function index(): Response
+    public function index(Request $request): Response
     {
+        $greet = '';
+        if ($name = $request->query->get('hello')) {
+            $greet = sprintf('<h1>Hello %s!</h1>', htmlspecialchars($name));
+        }
+
         return new Response(<<<EOF
             <html>
-                <body><img src="/images/under-construction.gif" /></body>
+                <body>$greet<img src="/images/under-construction.gif" /></body>
             </html>
```
]

---

.left-column[
  ### A. Contr√¥leur
  #### Maker bundle
  #### G√©n√©rer un contr√¥leur
  #### Personnaliser la route
  #### Ajouter un easter egg
]

.right-column[
Symfony expose les donn√©es de la requ√™te √† travers un objet `Request`. Lorsque Symfony voit un argument de contr√¥leur avec ce typage pr√©cis, il sait automatiquement qu'il doit vous le passer. Nous pouvons l'utiliser pour r√©cup√©rer le nom depuis le param√®tre d'URL et ajouter un titre `<h1>`.

Dans un navigateur, rendez-vous sur `/`, puis sur `/?hello=Fabien` pour constater la diff√©rence.

Nous aurions √©galement pu inclure le nom directement dans l'URL :
```diff
 class ConferenceController extends AbstractController
 {
-    #[Route('/', name: 'homepage')]
-    public function index(Request $request): Response
+    #[Route('/hello/{name}', name: 'homepage')]
+    public function index(string $name = ''): Response
     {
         $greet = '';
-        if ($name = $request->query->get('hello')) {
+        if ($name) {
             $greet = sprintf('<h1>Hello %s!</h1>', htmlspecialchars($name));
         }
```

La partie de la route {name} est un param√®tre de route dynamique - il fonctionne comme un joker. Vous pouvez maintenant vous rendre sur `/hello` et sur `/hello/Fabien` dans un navigateur pour obtenir les m√™mes r√©sultats qu'auparavant. Vous pouvez r√©cup√©rer la valeur du param√®tre `{name}` en ajoutant un argument portant le m√™me nom au contr√¥leur, donc $name.

> ‚ùó Annulez les changements que nous venons juste de faire via `git checkout .`

]

---

.left-column[
  ### A. Contr√¥leur
  #### Maker bundle
  #### G√©n√©rer un contr√¥leur
  #### Personnaliser la route
  #### Ajouter un easter egg
  #### D√©bogguer des variables
]

.right-column[
La fonction dump() est un utilitaire de d√©boggage tr√®s puissant. Elle est toujours disponible et vous permet de voir le contenu de variables complexes dans un format interactif.

Modifiez temporairement le fichier src/Controller/ConferenceController.php pour afficher le contenu de l'objet Request :

```diff
 use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
+use Symfony\Component\HttpFoundation\Request;
 use Symfony\Component\HttpFoundation\Response;
 use Symfony\Component\Routing\Annotation\Route;

 class ConferenceController extends AbstractController
 {
     #[Route('/', name: 'homepage')]
-    public function index(): Response
+    public function index(Request $request): Response
     {
+        dump($request);
+
         return new Response(<<<EOF
             <html>
                 <body>

```
Quand vous rafraichissez la page, une ic√¥ne "cible" apparait dans la barre de d√©boggage; elle vous permet d'inspecter le dump. Cliquez dessus pour acc√©der √† une page d√©di√©e rendant la navigation plus simple.

> ‚ùó Annulez les changements que nous venons juste de faire via `git checkout .`

]

---

.left-column[
  ### A. Contr√¥leur
  ### B. Base de donn√©es
  #### PostgreSQL
]

.right-column[
  Le site web du livre d'or de la conf√©rence permet de recueillir des commentaires pendant les conf√©rences. Nous avons besoin de stocker ces commentaires dans un stockage persistant.

Un commentaire est mieux d√©crit par une structure de donn√©es fixe : un nom, un email, le texte du commentaire et une photo facultative. Ce type de donn√©es se stocke facilement dans un moteur de base de donn√©es relationnelle traditionnel.

PostgreSQL est le moteur de base de donn√©es que nous allons utiliser.
#### Ajouter PostgreSQL √† Docker Compose
Sur notre machine locale, nous avons d√©cid√© d'utiliser Docker pour g√©rer nos services. Le fichier docker-compose.yaml g√©n√©r√© contient d√©j√† PostgreSQL en tant que service :

```yml
###> doctrine/doctrine-bundle ###
database:
    image: postgres:${POSTGRES_VERSION:-14}-alpine
    environment:
        POSTGRES_DB: ${POSTGRES_DB:-app}
        # You should definitely change the password in production
        POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-ChangeMe}
        POSTGRES_USER: ${POSTGRES_USER:-app}
volumes:
    - db-data:/var/lib/postgresql/data:rw
    # You may use a bind-mounted host directory instead, so that it is harder to accidentally remove the volume and lose all your data!
    # - ./docker/db/data:/var/lib/postgresql/data:rw
###< doctrine/doctrine-bundle ###
```

]

---

.left-column[
  ### A. Contr√¥leur
  ### B. Base de donn√©es
  #### PostgreSQL
]

.right-column[
Un serveur **PostgreSQL** sera alors install√© et certaines variables d'environnement, qui contr√¥lent le nom de la base de donn√©es et ses identifiants, seront configur√©es. Les valeurs n'ont pas vraiment d'importance.

Nous exposons √©galement le port PostgreSQL (`5432`) du conteneur √† l'h√¥te local (`docker-compose.override.yml`). Cela nous aidera √† acc√©der √† la base de donn√©es √† partir de notre machine :
```yaml
###> doctrine/doctrine-bundle ###
database:
    ports:
    - "5432"
###< doctrine/doctrine-bundle ###
```

> üí° L'extension `pdo_pgsql` a d√©j√† d√ª √™tre install√©e pr√©c√©demment lors de l'installation de PHP.

]

---

.left-column[
  ### A. Contr√¥leur
  ### B. Base de donn√©es
  #### PostgreSQL
  #### Docker compose
]

.right-column[
Lancez Docker Compose en arri√®re-plan (-d) :
```sh
docker compose up -d
```
Attendez un peu pour laisser d√©marrer la base de donn√©es, puis v√©rifiez que tout fonctionne bien :
```sh
docker compose ps
```

S'il n'y a pas de conteneurs en cours d'ex√©cution ou si la colonne State n'indique pas Up, v√©rifiez les logs de Docker Compose :
```sh
docker compose logs database
```

]

---

.left-column[
  ### A. Contr√¥leur
  ### B. Base de donn√©es
  #### PostgreSQL
  #### Docker compose
  #### Acc√©der √† la base de donn√©es
]

.right-column[
  'utilitaire en ligne de commande psql peut parfois s'av√©rer utile. Mais vous devez vous rappelez des informations d'identification et du nom de la base de donn√©es. Encore moins √©vident, vous devez aussi conna√Ætre le port local sur lequel la base de donn√©es tourne sur l'h√¥te. Docker choisit un port al√©atoire pour que vous puissiez travailler sur plus d'un projet en utilisant PostgreSQL en m√™me temps (le port local fait partie de la sortie de docker-compose ps).

Si vous utilisez psql avec la commande symfony, vous n'avez pas besoin de vous souvenir de quoi que ce soit.

La commande symfony d√©tecte automatiquement les services Docker en cours d'ex√©cution pour le projet et expose les variables d'environnement dont psql a besoin pour se connecter √† la base de donn√©es.

Gr√¢ce √† ces conventions, acc√©der √† la base de donn√©es avec symfony run est beaucoup plus facile :
]

---

.left-column[
### Nouveau projet symfony
### Postgresql
#### Installation
#### Connection
]
.right-column[
#### Connect to database
Via docker-compose exec
```bash
docker-compose exec database psql -U main -d main
```
Via pgcli, use value of DATABASE_URL
```bash
pgcli postgresql://localhost:49743/app?serverVersion=13&charset=utf8
```

#### Documentation 
##### Database
https://www.postgresql.org/docs/13/tutorial-accessdb.html

##### Table & query
https://www.postgresql.org/docs/13/tutorial-table.html
]

---

class: middle
.left-column[
### Nouveau projet symfony
### Postgresql
#### Installation
#### Connection
#### Commands
]
.right-column[
| Listing | Command | Argument |
|---|---|---|
| Table, index, view, or sequence | \d | name |
| Tables | \dt | name |
| Views | \dv | name |
| Permissions | \dp or \z | name |
| System tables | \dS | name |
| Types | \dT | name |
| Functions | \df | name |
| Operators | \do | name |
| Databases | \l | name |
]

---

class: middle
.left-column[
### Nouveau projet symfony
### Postgresql
### Environemment de dev
]
.right-column[
#### Si vous rencontrer des bugs
* **1 :** N'hesitez √† demander au formateur, meme si il doit se repeter.
* **2 :** Demander au gens qui vous entoure
* **3 :** Demander √† Google avec la bonne mani√®re. En clair ne faite pas un copier coller bete de votre erreur, car il ne vous repondra certainement avec les bonnes solutions. La bonne mani√®re c'est de prefixer par la technologie que vous utiliser, puis c'est un bug et ensuite un resum√© bref de votre erreur. Utiliser l'anglais vous apportera de meilleur resultat.

_**example :**_ symfony bug monolog don't work

#### Variables
Pour afficher toutes les variables d'environnement expos√©es 
```bash
# affiche toutes les variables (server, .env, docker, ...)
symfony var:export --debug --multiline

# afficher seulement les variables .env.*
symfony console debug:dotenv
```
]

---

class: middle
.left-column[
### Nouveau projet symfony
### Postgresql
### Environemment de dev
### Doctrine ORM
]
.right-column[
Par defaut Doctrine ORM utilise les annotations, nous allons nous utiliser les attributes qui sont fournit depuis php 8.0
```
doctrine:
    orm:
        mappings:
            App:
                type: attribute
```

Verifions que notre database est toujours presente
```bash
symfony console doctrine:database:create
```
]