name: inverse
class: center, middle, inverse
# Symfony Framework
# .red[PHP 8]
<div class="logo"><svg class="logo-1" fill="white" width="196" height="64" viewBox="0 0 196 64" style="fill-rule: evenodd; clip-rule: evenodd; stroke-linejoin: round; stroke-miterlimit: 2;"><g transform="matrix(0.101031,0,0,0.101031,2.39526,-0.329946)"><g transform="matrix(1.27705,0,0,1.27705,1143.65,155.404)"><path d="M320.958,94.576C320.958,107.301 317.357,117.884 310.155,126.323C302.952,134.763 293.386,140.971 281.456,144.947L331.695,223.685L290.072,223.685L246.727,150.647L230.025,150.647L230.025,223.685L193.837,223.685L193.837,40.361L247.787,40.361C296.568,40.361 320.958,58.433 320.958,94.576ZM283.312,94.576C283.312,84.855 280.462,77.764 274.762,73.301C269.062,68.838 260.38,66.607 248.715,66.607L230.025,66.607L230.025,124.931L249.908,124.931C260.954,124.931 269.283,122.501 274.895,117.641C280.506,112.78 283.312,105.092 283.312,94.576Z" style="fill-rule: nonzero;"></path></g><g transform="matrix(1.27705,0,0,1.27705,1486.87,208.548)"><path d="M313.005,64.751L241.159,227.264L208.153,217.058L277.612,67.402L195.163,67.402L195.163,40.361L313.005,40.361L313.005,64.751Z" style="fill-rule: nonzero;"></path></g><g transform="matrix(1.27705,0,0,1.27705,1335.53,155.404)"><path d="M253.752,12.524C257.994,12.524 261.75,13.43 265.019,15.241C268.289,17.053 270.852,19.55 272.708,22.731C274.563,25.912 275.491,29.447 275.491,33.335C275.491,37.224 274.563,40.758 272.708,43.94C270.852,47.121 268.289,49.64 265.019,51.495C261.75,53.351 257.994,54.279 253.752,54.279C249.51,54.279 245.733,53.351 242.419,51.495C239.105,49.64 236.52,47.121 234.664,43.94C232.808,40.758 231.88,37.224 231.88,33.335C231.88,29.447 232.808,25.912 234.664,22.731C236.52,19.55 239.105,17.053 242.419,15.241C245.733,13.43 249.51,12.524 253.752,12.524ZM201.658,83.309L276.419,83.309L276.419,198.897L313.402,198.897L313.402,223.685L200.332,223.685L200.332,198.897L241.424,198.897L241.424,108.097L201.658,108.097L201.658,83.309Z" style="fill-rule: nonzero;"></path></g><g transform="matrix(2.01117,0,0,2.01117,165.834,-128.735)"><path d="M261.043,177.319L211.622,177.319L211.622,218.681L254.382,218.681L254.382,228.302L211.622,228.302L211.622,271.803L264.332,271.803L264.332,280.93L201.096,280.93L201.096,167.944L262.441,167.944L261.043,177.319ZM213.76,150.758L245.501,134.23L250.682,143.851L216.72,156.432L213.76,150.758Z" style="fill-rule: nonzero;"></path></g><g transform="matrix(2.01117,0,0,2.01117,165.834,-128.735)"><path d="M312.861,273.201C321.248,273.201 329.06,270.651 336.297,265.553L341.642,272.46C337.969,275.53 333.501,277.984 328.238,279.82C322.975,281.657 317.987,282.575 313.272,282.575C304.994,282.575 297.922,280.766 292.056,277.148C286.191,273.529 281.723,268.376 278.653,261.688C275.583,255 274.048,247.133 274.048,238.088C274.048,229.426 275.583,221.696 278.653,214.898C281.723,208.101 286.218,202.756 292.139,198.863C298.059,194.971 305.131,193.025 313.354,193.025C323.935,193.025 333.282,196.287 341.395,202.81L335.968,210.129C328.128,204.757 320.426,202.07 312.861,202.07C307.488,202.07 302.733,203.441 298.594,206.182C294.455,208.923 291.22,212.993 288.89,218.393C286.561,223.793 285.396,230.358 285.396,238.088C285.396,245.927 286.547,252.465 288.849,257.7C291.152,262.935 294.373,266.828 298.512,269.377C302.65,271.926 307.434,273.201 312.861,273.201Z" style="fill-rule: nonzero;"></path></g><g transform="matrix(2.01117,0,0,2.01117,165.834,-128.735)"><path d="M386.388,193.025C394.118,193.025 400.641,194.834 405.959,198.452C411.277,202.07 415.251,207.224 417.883,213.912C420.514,220.6 421.83,228.549 421.83,237.759C421.83,246.421 420.473,254.137 417.759,260.907C415.046,267.677 411.003,272.981 405.63,276.819C400.258,280.656 393.761,282.575 386.141,282.575C378.412,282.575 371.874,280.725 366.529,277.024C361.184,273.324 357.168,268.13 354.482,261.441C351.796,254.753 350.453,246.914 350.453,237.923C350.453,228.987 351.81,221.148 354.523,214.405C357.237,207.662 361.294,202.413 366.694,198.658C372.093,194.903 378.658,193.025 386.388,193.025ZM386.388,201.988C369.887,201.988 361.636,213.967 361.636,237.923C361.636,261.661 369.805,273.529 386.141,273.529C402.478,273.529 410.646,261.606 410.646,237.759C410.646,213.912 402.56,201.988 386.388,201.988Z" style="fill-rule: nonzero;"></path></g><g transform="matrix(2.01117,0,0,2.01117,165.834,-128.735)"><path d="M463.945,261.359C463.945,265.635 465.301,268.76 468.015,270.734C470.729,272.707 474.443,273.694 479.157,273.694C483.982,273.694 489.053,272.652 494.37,270.569L497.33,278.463C494.973,279.669 492.136,280.656 488.82,281.424C485.503,282.191 481.953,282.575 478.171,282.575C473.566,282.575 469.413,281.739 465.713,280.067C462.012,278.395 459.093,275.955 456.955,272.748C454.817,269.541 453.748,265.745 453.748,261.359L453.748,168.52L426.94,168.52L426.94,159.639L463.945,159.639L463.945,261.359Z" style="fill-rule: nonzero;"></path></g><g transform="matrix(2.01117,0,0,2.01117,165.834,-128.735)"><path d="M520.121,241.87C520.231,248.833 521.491,254.657 523.904,259.345C526.316,264.032 529.509,267.513 533.483,269.788C537.458,272.063 541.885,273.201 546.764,273.201C551.15,273.201 555.11,272.57 558.646,271.309C562.182,270.048 565.979,268.02 570.035,265.224L575.38,272.872C571.433,275.942 566.952,278.326 561.936,280.026C556.919,281.725 551.999,282.575 547.175,282.575C539.336,282.575 532.552,280.725 526.823,277.024C521.094,273.324 516.722,268.102 513.707,261.359C510.692,254.616 509.184,246.777 509.184,237.841C509.184,229.125 510.705,221.381 513.748,214.611C516.791,207.84 521.08,202.55 526.617,198.74C532.154,194.93 538.486,193.025 545.613,193.025C552.52,193.025 558.496,194.711 563.539,198.082C568.583,201.454 572.434,206.278 575.093,212.555C577.751,218.832 579.081,226.246 579.081,234.798C579.081,236.059 578.999,238.417 578.834,241.87L520.121,241.87ZM545.859,202.564C541.09,202.564 536.855,203.674 533.155,205.894C529.454,208.114 526.48,211.472 524.232,215.967C521.985,220.463 520.669,226.027 520.285,232.66L569.377,232.66C569.158,222.793 566.938,215.31 562.717,210.211C558.496,205.113 552.876,202.564 545.859,202.564Z" style="fill-rule: nonzero;"></path></g><path d="M250.428,75.558C385.339,75.558 494.87,185.089 494.87,320C494.87,454.911 385.339,564.442 250.428,564.442C115.517,564.442 5.986,454.911 5.986,320C5.986,185.089 115.517,75.558 250.428,75.558ZM131.233,450.023L131.233,203.31L220.202,205.493C297.709,207.676 311.355,209.314 331.55,219.685C400.87,255.709 417.79,343.587 365.937,402.536L344.65,426.552L356.658,438.014L368.12,450.023L256.772,450.023L256.772,339.22L269.872,351.228L282.972,363.782L294.434,352.32C308.08,338.674 309.171,325.575 297.163,309.2C294.835,305.797 292.624,303.334 289.625,301.561C283.483,297.931 274.034,297.192 253.497,297.192L218.564,297.192L218.564,450.023L131.233,450.023Z"></path></g></svg></div>

---

class: middle


  .center[
    ### **Ma√Ætrisez le d√©veloppement web de haut niveau <br /> avec la Formation Symfony**
   ]
  
  **La formation Symfony** est destin√©e aux d√©veloppeurs qui souhaitent am√©liorer leurs comp√©tences en mati√®re de d√©veloppement web. Elle vise √† fournir aux participants une compr√©hension approfondie du framework Symfony, ainsi qu'√† leur donner **les connaissances** et **les comp√©tences** n√©cessaires pour cr√©er des applications web de qualit√© sup√©rieure.

.center[

## üßó

]

Au cours de la formation, les participants apprendront comment utiliser les diff√©rents composants de Symfony pour construire des applications web robustes et √©volutives. 

Ils d√©couvriront √©galement comment travailler avec les diff√©rents mod√®les de donn√©es, comment g√©rer les utilisateurs et les autorisations, et comment impl√©menter des fonctionnalit√©s avanc√©es telles que :

* Les formulaires
* Les validations
* Les routes
* Les contr√¥leurs
* Les vues
* etc...

---
class: middle

.center[
  ### **√âlevez vos comp√©tences en √©quipe, <br />domptez les d√©fis du web et brillez sur le March√© ! ü§©**
]

En outre, la formation permettra aux participants de d√©velopper **leur capacit√© √† travailler en √©quipe**, √† **communiquer avec d'autres d√©veloppeurs** et √† **g√©rer les d√©fis du d√©veloppement web**. Les participants auront √©galement l'opportunit√© de mettre en pratique leurs comp√©tences en travaillant sur des projets concrets.

.center[
## üòé 
]

En somme, la formation Symfony est une occasion unique pour les d√©veloppeurs de d√©velopper leurs comp√©tences en d√©veloppement web et de se faire remarquer sur le march√© du travail.

Les participants auront les outils et les connaissances n√©cessaires pour construire des applications web performantes et pour atteindre leurs objectifs professionnels.

.center[
  <img src="https://images.unsplash.com/photo-1612712191426-54db4d88cbec?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=600&h=200&q=80" alt="D√©couverte de symfony" />
]

---

class: middle
.center[

## Au programme

]

.pull-left[
#### **Installation de notre environnement**

* Gitpod / Codespace (github)
* Docker
* Un environement docker avec :
  * PHP 8.2
  * Composer
  * Nodejs
  * Symfony cli
]

.pull-right[
#### **Symfony 6**

* Nouveau projet symfony 6.3
* Base de donn√©es avec Postgresql
* Interface web (Easy admin, Twig)
* Environnement de dev
* Entit√©, Controller, Event
* Messages
* Redisq
]
 
.center[
  <img src="https://images.unsplash.com/photo-1484480974693-6ca0a78fb36b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=600&q=80&h=200" />
]

---
class: center, middle, inverse
# 1. Environnement de travail
---

class: middle
.center[
### **Editeur en ligne Gitpod**
]

.pull-left.mt-2[
#### Avantages de l'utilisation d'√©diteurs de code en ligne pour la formation Symfony
* Acc√®s depuis n'importe o√π, √† tout moment
* Interface utilisateur conviviale
* Fonctionnalit√©s de collaboration en temps r√©el
* Int√©gration transparente avec des services tels que Git
* Exp√©rience de d√©veloppement uniforme pour tous les participants
* Possibilit√© de se concentrer sur le d√©veloppement des comp√©tences
* Acc√®s aux m√™mes outils et fonctionnalit√©s pour tous les participants
* Facilitation de la collaboration en √©quipe et du partage de connaissances
]
.pull-right.center.middle[
  <img src="img/gitpod-tools.jpg" alt="Gitpod tools" width="450px" />
]

En utilisant des √©diteurs de code en ligne pour la formation Symfony, vous b√©n√©ficierez d'une exp√©rience plus souple et plus facile, tout en garantissant une exp√©rience de d√©veloppement uniforme pour tous les participants.

.center[
  <a href="https://gitpod.io" target="_blank">
    <img src="img/gitpod-logo.png" width="300" />
    <br />Go to Gitpod
  </a>
]

---

class: middle

.center[
### **Mise en place**

]
#### **Utilisation d'√©diteurs de code en ligne pour la formation Symfony**
Pendant cette formation, nous privil√©gierons l'utilisation de Gitpod. Pour pouvoir en b√©n√©ficier, vous devrez disposer d'un nouveau d√©p√¥t Git existant (sur Github, Gitlab ou Bitbucket).

* ‚è© **Cr√©er un nouveau d√©p√¥t git**

Gitpod embarque une image par d√©faut accessible √† partir de https://hub.docker.com/r/gitpod/workspace-full. Toutefois, il est possible de personnaliser votre environnement de d√©veloppement en configurant, par exemple, les extensions de PHP.

Pour sp√©cifier l'utilisation d'une image Docker √† partir d'un fichier **Dockerfile**, il est n√©cessaire d'ajouter un fichier `.gitpod.yml` √† la racine du projet git avec le contenu suivant :
```yml
image:
    file: .gitpod.Dockerfile
```

* ‚è© **Ajouter le fichier `.gitpod` √† votre nouveau projet git**

---

class: middle

Ensuite, il faut cr√©er un fichier nomm√© `.gitpod.Dockerfile` √† la racine du projet et y ajouter le contenu suivant :
```dockerfile
FROM gitpod/workspace-full:latest

RUN sudo apt update
RUN sudo apt install -y apt-utils apt-transport-https postgresql postgresql-contrib
RUN sudo install-packages php-intl php-redis php-amqp php-pdo_pgsql

RUN curl -1sLf 'https://dl.cloudsmith.io/public/symfony/stable/setup.deb.sh' | sudo -E bash
RUN sudo apt install symfony-cli
```

Ce fichier **Dockerfile** sp√©cifie l'utilisation de l'image de base `gitpod/workspace-full` et installe des paquets suppl√©mentaires n√©cessaires, tels que `php-intl`, `php-redis` et `php-amqp`. Il installe √©galement `apt-utils` et `apt-transport-https` pour la gestion des paquets, et installe `symfony-cli` en utilisant les scripts d'installation fournis par Symfony. Bien s√ªr, le contenu de ce fichier peut √™tre modifi√© en fonction des besoins sp√©cifiques de chaque projet.

Puis, committez et poussez ces deux fichiers sur votre branche principale.

* ‚è© **Rendez-vous sur https://gitpod.io**
* ‚è© **Puis sur l'onglet "Project", cliquez sur "New Project".**
* ‚è© **Choisissez le r√©pertoire git pr√©alablement configur√©.**

.info[
  Assurez-vous de suivre ces √©tapes pour vous pr√©parer √† utiliser l'√©diteur de code en ligne pour la formation Symfony.
]

---

.left-column[
### Editeur en ligne
### Mise en place
### Verification
]
.right-column[
#### **Pr√©paration pour la formation**
* Sur l'√©diteur de code en ligne, certains logiciels sont d√©j√† install√©s.
* V√©rifions que nous avons tous les outils n√©cessaires pour cette formation.

Assurez-vous de v√©rifier les outils n√©cessaires avant de commencer la formation avec un √©diteur de code en ligne.

| .red[software] | .red[command version] | .red[version] |
|--|--|
| **docker** | `docker --version` | +20.10 |
| **docker compose** | `docker compose version` | +2.10 |
| **php** | `php -version` | +8.1 |
| **composer** | `composer --version` | +2.4 |
| **node** | `node --version` | +16 |
| **yarn** | `yarn --version` | +1.22 |
]

---

.left-column[
### Editeur en ligne
### Mise en place
### Verification
### Initialisation
]
.right-column[

### **Initialisation du projet avec Symfony**
* Nous allons initialiser le projet avec le client Symfony.
* Nous utiliserons la **version 6.2**, la derni√®re en date.
* Nous utiliserons √©galement **PHP 8.1+**.

Assurez-vous de suivre ces √©tapes pour initialiser correctement votre projet avec Symfony en utilisant les derni√®res versions disponibles.

Lancer la commande suivante depuis le terminal, elle va permettre de cloner symfony-skeleton, lancer composer ...
‚ùó Assurez-vous que le repertoire en cours soit vide.
```sh
symfony new --dir=guestbook --webapp --version=6.2
cd guestbook
rm -rf .git
```
* **`new`** L'argument permet de construire un nouveau projet
* **`--dir=guestbook`** repertoire d'installation du projet symfony
* **`--webapp`** L'option installe tous les paquets dont vous avez g√©n√©ralement besoin pour cr√©er des applications Web.

Le binaire symfony fournit √©galement un outil permettant de v√©rifier si votre ordinateur r√©pond √† toutes les exigences. Ouvrez votre terminal de console et ex√©cutez cette commande :
```sh
symfony book:check-requirements
```
]

---

.left-column[
### Editeur en ligne
### Mise en place
### Verification
### Initialisation
### VsCode Extensions
]
.right-column[

Nous aurons besoin de certaines extension sur Vscode pour travailler correctement et facilement.

Liste des extensions
- PHP Debug
- PHP Intelephense
- PHP Namespace Resolver
- DotENV
- YAML
- PHP 8 Getter & Setter
- Extension Twig Language 2
]

---
class: center, middle, inverse
# 2. En route vers symfony 6
https://symfony.com/doc/current/the-fast-track/fr/index.html
---


### .center[Pr√©sentation du projet]
Nous devons trouver un projet sur lequel travailler. C'est un certain d√©fi car nous devons choisir un projet assez vaste pour couvrir compl√®tement Symfony, mais en m√™me temps, il devrait √™tre assez petit ; Afin que vous ne vous ennuyiez pas √† impl√©menter des fonctionnalit√©s similaires plusieurs fois.

#### Description du projet
Le projet a pour but d'obtenir un retour d'exp√©rience sur les conf√©rences : une liste des conf√©rences sur la page d'accueil ainsi qu'une page pour chacune d'entre elles, pleine de commentaires sympathiques. Un commentaire est compos√© d'un petit texte et d'une photo, optionnelle, prise pendant la conf√©rence.

Le projet comprendra plusieurs applications : une application web traditionnelle avec une interface HTML, une API et une SPA pour les t√©l√©phones mobiles.
#### La ma√Ætrise s‚Äôacquiert par la pratique
La ma√Ætrise s‚Äôacquiert par la pratique. Point final. Lire un livre sur Symfony, c'est bien. Coder une application sur votre ordinateur tout en lisant un livre sur Symfony, c'est encore mieux. Cette formation est tr√®s sp√©cial puisque tout a √©t√© fait pour que vous puissiez suivre et  coder.

#### R√©cup√©rer le code source du projet
Clonez [le d√©p√¥t du livre](https://github.com/the-fast-track/book-6.2-1) d'or quelque part sur votre machine :
```sh
symfony new --version=6.2-1 --book guestbook
```

---

.left-column[
### A. Structure
]
.right-column[

Comme Git est install√© sur notre machine, `symfony new` nous a √©galement cr√©√© un d√©p√¥t Git, dans lequel a √©t√© ajout√© le tout premier commit.

Jetons un coup d'oeil √† la structure des r√©pertoires :
```
‚îú‚îÄ‚îÄ bin/
‚îú‚îÄ‚îÄ composer.json
‚îú‚îÄ‚îÄ composer.lock
‚îú‚îÄ‚îÄ config/
‚îú‚îÄ‚îÄ public/
‚îú‚îÄ‚îÄ src/
‚îú‚îÄ‚îÄ symfony.lock
‚îú‚îÄ‚îÄ var/
‚îî‚îÄ‚îÄ vendor/
```
* Le r√©pertoire **`bin/`** contient le principal point d'entr√©e de la ligne de commande : `console`. Vous l'utiliserez tout le temps.

* Le r√©pertoire **`config/`** est constitu√© d'un ensemble de fichiers de configuration sensibles, initialis√©s avec des valeurs par d√©faut. Un fichier par paquet. Vous les modifierez rarement : faire confiance aux valeurs par d√©faut est presque toujours une bonne id√©e.

* Le r√©pertoire **`public/`** est le r√©pertoire racine du site web, et le script index.php est le point d'entr√©e principal de toutes les ressources HTTP dynamiques.

]
---

.left-column[
### A. Structure

]
.right-column[
* Le r√©pertoire **`src/`** h√©berge tout le code que vous allez √©crire ; c'est ici que vous passerez la plupart de votre temps. Par d√©faut, toutes les classes de ce r√©pertoire utilisent le namespace PHP App. C'est votre r√©pertoire de travail, votre code, votre logique de domaine. Symfony n'a pas grand-chose √† y faire.

* Le r√©pertoire **`var/`** contient les caches, les logs et les fichiers g√©n√©r√©s par l'application lors de son ex√©cution. Vous pouvez le laisser tranquille. C'est le seul r√©pertoire qui doit √™tre en √©criture en production.

* Le r√©pertoire **`vendor/`** contient tous les paquets install√©s par Composer, y compris Symfony lui-m√™me. C'est notre arme secr√®te pour un maximum de productivit√©. Ne r√©inventons pas la roue. Vous profiterez des biblioth√®ques existantes pour vous faciliter le travail. Le r√©pertoire est g√©r√© par Composer. N'y touchez jamais.

C'est tout ce que vous avez besoin de savoir pour l'instant. üèÅ

> üì¨ Commitez notre travail via `git commit .`

]

---

.left-column[
### A. Structure
### B. Resources publique
]
.right-column[
#### Cr√©er des ressources publiques
Tout ce qui se trouve dans le r√©pertoire **`public/`** est accessible par un navigateur. Par exemple, si vous d√©placez votre fichier GIF anim√© (nommez-le under-construction.gif) dans un nouveau r√©pertoire `public/images/`, il sera alors disponible √† une URL comme https://localhost/images/under-construction.gif.

T√©l√©chargez mon image GIF ici :
```sh
mkdir public/images/
php -r "copy('http://clipartmag.com/images/website-under-construction-image-6.gif', 'public/images/under-construction.gif');"
```
]

---

.left-column[
### A. Structure
### B. Resources publique
### C. Serveur symfony
]
.right-column[
####¬†Lancer un serveur web local
La commande symfony inclut un serveur web optimis√© pour le d√©veloppement. Comme vous vous en doutez, il marche tr√®s bien avec Symfony. Cependant, ne l'utilisez jamais en production.

√Ä partir du r√©pertoire du projet, d√©marrez le serveur web en arri√®re-plan (option -d) :
```sh
symfony server:start -d
```

depuis l'√©diteur en ligne vous pouvez retrouver le lien de notre serveur lanc√© sur l'onglet `PORTS`. Choisissez le port 8000, un nouvel onglet s'ouvre affichant une page "welcome to symfony"
> üóí Pour r√©soudre les probl√®mes, ex√©cutez `symfony server:log` ; cette commande affiche les derniers logs de votre serveur web, de PHP et de votre application.

Naviguez vers `/images/under-construction.gif.` Pour percevoir notre image anim√© sur notre projet symfony.

> üì¨ Commitez notre travail via `git commit .`
]


---

.left-column[
### A. Structure
### B. Resources publique
### C. Serveur symfony
### D. Diagnostiquer
]
.right-column[
Mettre en place un projet, c'est aussi avoir les bons outils pour d√©boguer les probl√®mes. Fort heureusement, des assistants tr√®s utiles sont inclus avec le paquet webapp.

#### D√©couvrir les outils de d√©bogage de Symfony
Pour commencer, le Symfony Profiler vous fait gagner un temps fou lorsque vous avez besoin de trouver l'origine d'un probl√®me.

Si vous regardez la page d'accueil

.center[![Debug page](img/debug-page.png)]

Ce n'est qu'une page de remplissage, car nous n'avons toujours pas d√©fini de page d'accueil. M√™me si la page par d√©faut qui vous accueille est belle, c'est une page d'erreur **`404`**.
]

---

.left-column[
### A. Structure
### B. Resources publique
### C. Serveur symfony
### D. Diagnostiquer
]
.right-column[

Si vous vous rendez sur la route `/_profiler` puis la premi√®re ligne avce le code **`404`**, vous obtenez le "vrai" message d'exception dans les logs du *Symfony Profiler*.

.center[![Symfony profiler](img/symfony-profiler.png)]

Les logs sont √©galement tr√®s utiles dans les sessions de d√©bogage. Symfony a une commande pratique pour consulter tous les logs (du serveur web, de PHP et de votre application) :
```sh
symfony server:log
```
]

---

.left-column[
### A. Structure
### B. Resources publique
### C. Serveur symfony
### D. Diagnostiquer
### E. Les environemments
]
.right-column[

#### Comprendre les environnements Symfony
Comme le Symfony Profiler n'est utile que pendant le d√©veloppement, nous voulons √©viter qu'il soit install√© en production. Par d√©faut, Symfony ne l'installe que pour les environnements de dev et de test.

Symfony int√®gre une notion d'environnement. Par d√©faut, il y en a trois, mais vous pouvez en ajouter autant que vous le souhaitez : `dev`, `prod` et `test`. Tous les environnements partagent le m√™me code, mais ils repr√©sentent des configurations diff√©rentes.

Par exemple, tous les outils de d√©bogage sont activ√©s en environnement de `dev`. Dans celui de `prod`, l'application est optimis√©e pour la performance.

Basculer d'un environnement √† l'autre peut se faire en changeant la variable d'environnement `APP_ENV`.

#### G√©rer la configuration des environnements
`APP_ENV` peut √™tre d√©fini en utilisant des variables d'environnement "r√©elles" depuis votre terminal : `export APP_ENV=dev`

Essayez de modifier la valeur de la variable `APP_ENV` √† "prod", redemarrez le serveur symfony, puis rendez-vous sur la page du profiler qui n'est disponible qu'en environnement de d√©veloppement.

Pour supprimer notre variable d'environnement, vous pouvez utiliser la commande `unset APP_ENV` dans un terminal
]

---

.left-column[
### A. Structure
### B. Resources publique
### C. Serveur symfony
### D. Diagnostiquer
### E. Les environemments
]
.right-column[
L'utilisation de variables d'environnement r√©elles est la meilleure fa√ßon de d√©finir des valeurs comme `APP_ENV` en production. Mais sur les machines de d√©veloppement, avoir √† d√©finir beaucoup de variables d'environnement peut s'av√©rer fastidieux. D√©finissez-les plut√¥t dans un fichier `.env.`

Un fichier sensible `.env` a √©t√© g√©n√©r√© automatiquement pour vous lorsque le projet a √©t√© cr√©√© :
```sh
###> symfony/framework-bundle ###
APP_ENV=dev
APP_SECRET=76f040716bf0a94fa2409642b1883e55
###< symfony/framework-bundle ###
```
> üí° N'importe quel paquet peut ajouter plus de variables d'environnement √† ce fichier gr√¢ce √† leur [recette utilis√©e par Symfony Flex](https://github.com/symfony/recipes).

Le fichier .env est commit√© sur le d√©p√¥t Git et liste les valeurs par d√©faut de la production. Vous pouvez surcharger ces valeurs en cr√©ant un fichier .env.local. Ce fichier ne doit pas √™tre commit√© : c'est pourquoi le fichier .gitignore l'ignore d√©j√†.

Ne stockez jamais des donn√©es secr√®tes ou sensibles dans ces fichiers. Nous verrons comment g√©rer ces donn√©es sensibles dans une autre √©tape.
]

---
class: center, middle, inverse
# 3. Notre premi√®re route
---

.left-column[
  ### A. Maker bundle
]
.right-column[
La page d'accueil est une ennuyeuse page d'erreur 404. Corrigeons cela.

Lorsqu'une requ√™te HTTP arrive au serveur, comme pour notre page d'accueil (http://localhost:8000/), **Symfony** essaie de trouver une route qui corresponde au chemin de la requ√™te (`/` ici). Une route est le lien entre le chemin de la requ√™te et un callable PHP, une fonction devant cr√©er la r√©ponse HTTP associ√©e √† cette requ√™te.

Ces callables sont nomm√©s **"contr√¥leurs"**. Dans Symfony, la plupart des contr√¥leurs sont impl√©ment√©s sous la forme de classes PHP. Vous pouvez cr√©er ces classes manuellement, mais comme nous aimons aller vite, voyons comment Symfony peut nous aider.

#### Se faciliter la vie avec le Maker Bundle
Pour g√©n√©rer des contr√¥leurs facilement, nous pouvons utiliser le paquet `symfony/maker-bundle`, qui a √©t√© install√© en tant que composant du paquet `webapp`.

**Le Maker Bundle** vous permet de g√©n√©rer un grand nombre de classes diff√©rentes. Nous l'utiliserons constamment dans cette formation. Chaque **"g√©n√©rateur"** correspond √† une commande et chacune d'entre elles appartient au m√™me namespace `make`.

La commande `list`, int√©gr√©e nativement √† la console symfony, permet d'afficher toutes les commandes disponibles sous un namespace donn√©. Utilisez-la pour d√©couvrir les g√©n√©rateurs fournis par **Maker Bundle** :
```sh
symfony console list make
```
]

---

.left-column[
  ### A. Maker bundle
  ### B. G√©n√©rer un contr√¥leur
]
.right-column[
#### G√©n√©rer un contr√¥leur
Cr√©ez votre premier Controller avec la commande `make:controller` :
```sh
symfony console make:controller ConferenceController
```
La commande cr√©e une classe `ConferenceController` dans le r√©pertoire `src/Controller/`. La classe g√©n√©r√©e contient du code standard pr√™t √† √™tre ajust√© :
    
```php
# src/Controller/ConferenceController.php
namespace App\Controller;

use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\Routing\Annotation\Route;

class ConferenceController extends AbstractController
{
    #[Route('/conference', name: 'conference')]
    public function index(): Response
    {
        return $this->render('conference/index.html.twig', [
            'controller_name' => 'ConferenceController',
        ]);
    }
}
```

> üì¨ Commitez notre travail via `git commit .`
]

---

.left-column[
  ### A. Maker bundle
  ### B. G√©n√©rer un contr√¥leur
  ### C. Personnaliser la route
]

.right-column[
L'attribut `#[Route('/conference', name: 'conference')]` est ce qui fait de la m√©thode `index()` un contr√¥leur (la configuration est √† c√¥t√© du code qu'elle configure).

Lorsque vous visitez la page `/conference` dans un navigateur, le contr√¥leur est ex√©cut√© et une r√©ponse est renvoy√©e.


Modifiez la route afin qu'elle corresponde √† la page d'accueil (`/`) :

```diff
class ConferenceController extends AbstractController
{
-   #[Route('/conference', name: 'app_conference')]
+   #[Route('/', name: 'homepage')]
    public function index(): Response
    {
```

Le nom de la route (`name`) sera utile lorsque nous voudrons faire r√©f√©rence √† la page d'accueil dans notre code. Au lieu de coder en dur le chemin `/`, nous utiliserons le nom de la route. √Ä la place de la page par d√©faut, retournons une simple page HTML :
```diff
     public function index(): Response
     {
-        return $this->render('conference/index.html.twig', [
-            'controller_name' => 'ConferenceController',
-        ]);
+        return new Response(<<<EOF
+            <html>
+                <body><img src="/images/under-construction.gif" /></body>
+            </html>
+        EOF);
     }
```
]

---

.left-column[
  ### A. Maker bundle
  ### B. G√©n√©rer un contr√¥leur
  ### C. Personnaliser la route
]

.right-column[
Rafra√Æchissez le navigateur :

![Symfony Contr√¥leur](img/symfony-controleur.png)

La responsabilit√© principale d'un contr√¥leur est de retourner une r√©ponse **HTTP** (Response) pour la requ√™te.

> üì¨ Commitez notre travail via `git commit .`
]

---

.left-column[
  ### A. Maker bundle
  ### B. G√©n√©rer un contr√¥leur
  ### C. Personnaliser la route
  ### D. Ajouter un easter egg
]

.right-column[
#### Ajouter un easter egg
Pour montrer comment une r√©ponse peut tirer parti de l'information contenue dans la requ√™te, ajoutons un petit easter egg. Lorsqu'une requ√™te vers la page d'accueil sera r√©alis√©e avec un param√®tre d'URL comme `?hello=Fabien`, nous ajouterons du texte pour saluer la personne :

```diff
 namespace App\Controller;

 use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
+use Symfony\Component\HttpFoundation\Request;
 use Symfony\Component\HttpFoundation\Response;
 use Symfony\Component\Routing\Annotation\Route;

 class ConferenceController extends AbstractController
 {
     #[Route('/', name: 'homepage')]
-    public function index(): Response
+    public function index(Request $request): Response
     {
+        $greet = '';
+        if ($name = $request->query->get('hello')) {
+            $greet = sprintf('<h1>Hello %s!</h1>', htmlspecialchars($name));
+        }
+
         return new Response(<<<EOF
             <html>
-                <body><img src="/images/under-construction.gif" /></body>
+                <body>$greet<img src="/images/under-construction.gif" /></body>
             </html>
```
]

---

.left-column[
  ### A. Maker bundle
  ### B. G√©n√©rer un contr√¥leur
  ### C. Personnaliser la route
  ### D. Ajouter un easter egg
]

.right-column[
Symfony expose les donn√©es de la requ√™te √† travers un objet `Request`. Lorsque Symfony voit un argument de contr√¥leur avec ce typage pr√©cis, il sait automatiquement qu'il doit vous le passer. Nous pouvons l'utiliser pour r√©cup√©rer le nom depuis le param√®tre d'URL et ajouter un titre `<h1>`.

Dans un navigateur, rendez-vous sur `/`, puis sur `/?hello=Fabien` pour constater la diff√©rence.

Nous aurions √©galement pu inclure le nom directement dans l'URL :
```diff
 class ConferenceController extends AbstractController
 {
-    #[Route('/', name: 'homepage')]
-    public function index(Request $request): Response
+    #[Route('/hello/{name}', name: 'homepage')]
+    public function index(string $name = ''): Response
     {
         $greet = '';
-        if ($name = $request->query->get('hello')) {
+        if ($name) {
             $greet = sprintf('<h1>Hello %s!</h1>', htmlspecialchars($name));
         }
```

La partie de la route {name} est un param√®tre de route dynamique - il fonctionne comme un joker. Vous pouvez maintenant vous rendre sur `/hello` et sur `/hello/Fabien` dans un navigateur pour obtenir les m√™mes r√©sultats qu'auparavant. Vous pouvez r√©cup√©rer la valeur du param√®tre `{name}` en ajoutant un argument portant le m√™me nom au contr√¥leur, donc $name.

> ‚ùó Annulez les changements que nous venons juste de faire via `git checkout .`

]

---

.left-column[
  ### A. Maker bundle
  ### B. G√©n√©rer un contr√¥leur
  ### C. Personnaliser la route
  ### D. Ajouter un easter egg
  ### E. D√©bogguer des variables
]

.right-column[
La fonction dump() est un utilitaire de d√©boggage tr√®s puissant. Elle est toujours disponible et vous permet de voir le contenu de variables complexes dans un format interactif.

Modifiez temporairement le fichier src/Controller/ConferenceController.php pour afficher le contenu de l'objet Request :

```diff
 use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
+use Symfony\Component\HttpFoundation\Request;
 use Symfony\Component\HttpFoundation\Response;
 use Symfony\Component\Routing\Annotation\Route;

 class ConferenceController extends AbstractController
 {
     #[Route('/', name: 'homepage')]
-    public function index(): Response
+    public function index(Request $request): Response
     {
+        dump($request);
+
         return new Response(<<<EOF
             <html>
                 <body>

```
Quand vous rafraichissez la page, une ic√¥ne "cible" apparait dans la barre de d√©boggage; elle vous permet d'inspecter le dump. Cliquez dessus pour acc√©der √† une page d√©di√©e rendant la navigation plus simple.

> ‚ùó Annulez les changements que nous venons juste de faire via `git checkout .`

]

---
class: center, middle, inverse
# 4. Gestion des donn√©es
---

.left-column[
  ### A. Base de donn√©es
  #### PostgreSQL
]

.right-column[
  Le site web du livre d'or de la conf√©rence permet de recueillir des commentaires pendant les conf√©rences. Nous avons besoin de stocker ces commentaires dans un stockage persistant.

Un commentaire est mieux d√©crit par une structure de donn√©es fixe : un nom, un email, le texte du commentaire et une photo facultative. Ce type de donn√©es se stocke facilement dans un moteur de base de donn√©es relationnelle traditionnel.

PostgreSQL est le moteur de base de donn√©es que nous allons utiliser.
#### Ajouter PostgreSQL √† Docker Compose
Sur notre machine locale, nous avons d√©cid√© d'utiliser Docker pour g√©rer nos services. Le fichier docker-compose.yaml g√©n√©r√© contient d√©j√† PostgreSQL en tant que service :

```yml
###> doctrine/doctrine-bundle ###
database:
    image: postgres:${POSTGRES_VERSION:-14}-alpine
    environment:
        POSTGRES_DB: ${POSTGRES_DB:-app}
        # You should definitely change the password in production
        POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-ChangeMe}
        POSTGRES_USER: ${POSTGRES_USER:-app}
volumes:
    - db-data:/var/lib/postgresql/data:rw
    # You may use a bind-mounted host directory instead, so that it is harder to accidentally remove the volume and lose all your data!
    # - ./docker/db/data:/var/lib/postgresql/data:rw
###< doctrine/doctrine-bundle ###
```

]

---

.left-column[
  ### A. Base de donn√©es
  #### PostgreSQL
]

.right-column[
Un serveur **PostgreSQL** sera alors install√© et certaines variables d'environnement, qui contr√¥lent le nom de la base de donn√©es et ses identifiants, seront configur√©es. Les valeurs n'ont pas vraiment d'importance.

Nous exposons √©galement le port PostgreSQL (`5432`) du conteneur √† l'h√¥te local (`docker-compose.override.yml`). Cela nous aidera √† acc√©der √† la base de donn√©es √† partir de notre machine :
```yaml
###> doctrine/doctrine-bundle ###
database:
    ports:
    - "5432"
###< doctrine/doctrine-bundle ###
```

> üí° L'extension `pdo_pgsql` a d√©j√† d√ª √™tre install√©e pr√©c√©demment lors de l'installation de PHP.

]

---

.left-column[
  ### A. Base de donn√©es
  #### PostgreSQL
  #### Docker compose
]

.right-column[
Lancez Docker Compose en arri√®re-plan (-d) :
```sh
docker compose up -d
```
Attendez un peu pour laisser d√©marrer la base de donn√©es, puis v√©rifiez que tout fonctionne bien :
```sh
docker compose ps
```

S'il n'y a pas de conteneurs en cours d'ex√©cution ou si la colonne State n'indique pas Up, v√©rifiez les logs de Docker Compose :
```sh
docker compose logs database
```

]

---

.left-column[
  ### A. Base de donn√©es
  #### PostgreSQL
  #### Docker compose
  #### Acc√©der √† la base de donn√©es
]

.right-column[
L'utilitaire en ligne de commande `psql` peut parfois s'av√©rer utile. Mais vous devez vous rappelez des informations d'identification et du nom de la base de donn√©es. Encore moins √©vident, vous devez aussi conna√Ætre le port local sur lequel la base de donn√©es tourne sur l'h√¥te. Docker choisit un port al√©atoire pour que vous puissiez travailler sur plus d'un projet en utilisant PostgreSQL en m√™me temps (le port local fait partie de la sortie de `docker-compose ps`).

Si vous utilisez `psql` avec la commande `symfony`, vous n'avez pas besoin de vous souvenir de quoi que ce soit.

La commande symfony d√©tecte automatiquement les services Docker en cours d'ex√©cution pour le projet et expose les variables d'environnement dont `psql` a besoin pour se connecter √† la base de donn√©es.

Gr√¢ce √† ces conventions, acc√©der √† la base de donn√©es avec symfony run est beaucoup plus facile :
```sh
symfony run psql
```

> üí° Ou via un `docker compose exec` sur le container `database`
>```sh
> docker compose exec database psql app app
> ```

Documentation postgresql
* structure : https://www.postgresql.org/docs/13/tutorial-accessdb.html
* table & requ√™tes : https://www.postgresql.org/docs/13/tutorial-table.html
]

---

.left-column[
  ### A. Base de donn√©es
  #### PostgreSQL
  #### Docker compose
  #### Acc√©der √† la base de donn√©es
  #### Exposer des variables d'environnement
]
.right-column[
#### Exposer des variables d'environnement
Pour afficher toutes les variables d'environnement expos√©es:
* affiche toutes les variables (server, .env, docker, ...)
```bash
symfony var:export --debug --multiline
```
* afficher seulement les variables dans les fichiers `.env.*`
```sh
symfony console debug:dotenv
```
]

---

.left-column[
  ### A. Base de donn√©es
  ### B. Doctrine ORM
  #### Configurer Doctrine ORM
]
.right-column[
Pour interagir avec la base de donn√©es depuis PHP, nous allons nous appuyer sur [**Doctrine**](https://www.doctrine-project.org/), un ensemble de biblioth√®ques qui nous aide √† g√©rer les bases de donn√©es : Doctrine DBAL (une couche d'abstraction de la base de donn√©es), **Doctrine** ORM (une librairie pour manipuler le contenu de notre base de donn√©es en utilisant des objets PHP), et Doctrine Migrations.

#### Configurer Doctrine ORM
Comment est-ce que Doctrine est au courant de notre connexion √† la base de donn√©es ? La recette de Doctrine a ajout√© un fichier de configuration qui contr√¥le son comportement : `config/packages/doctrine.yaml`. Le param√®tre principal est le `DSN` de la base de donn√©es, une cha√Æne contenant toutes les informations sur la connexion : identifiants, h√¥te, port, etc. Par d√©faut, Doctrine recherche une variable d'environnement `DATABASE_URL`.

Presque tous les paquets install√©s sont configur√©s dans le r√©pertoire `config/packages/`. Les valeurs par d√©faut ont √©t√© choisies avec soin pour fonctionner avec la plupart des applications.

#### Comprendre les conventions des variables d'environnement de Symfony
Vous pouvez d√©finir la variable `DATABASE_URL` manuellement dans le fichier `.env` ou `.env.local`. En fait, gr√¢ce √† la recette du paquet, vous verrez un exemple de variable `DATABASE_URL` dans votre fichier `.env`. Mais comme le port expos√© par Docker vers PostgreSQL peut changer, c'est assez lourd. Il y a une meilleure solution.

Au lieu de coder en dur la variable `DATABASE_URL` dans un fichier, nous pouvons pr√©fixer toutes les commandes avec symfony. Ceci d√©tectera les services ex√©cut√©s par Docker (lorsque le tunnel est ouvert) et d√©finira automatiquement la variable d'environnement.

Docker Compose fonctionne parfaitement avec Symfony gr√¢ce √† ces variables d'environnement.
]

---

.left-column[
  ### A. Base de donn√©es
  ### B. Doctrine ORM
  #### Configurer Doctrine ORM
]
.right-column[
V√©rifiez toutes les variables d'environnement expos√©es en ex√©cutant symfony var:export :

```sh
symfony var:export
DATABASE_URL=postgres://main:main@127.0.0.1:32781/main?sslmode=disable&charset=utf8
# ...
```
Vous rappelez-vous du nom du service database utilis√© dans les configurations Docker ? Les noms des services sont utilis√©s comme pr√©fixes pour d√©finir des variables d'environnement telles que `DATABASE_URL`. Si vos services sont nomm√©s selon les conventions Symfony, aucune autre configuration n'est n√©cessaire.

#### Modifier la valeur par d√©faut de DATABASE_URL dans le fichier .env
Nous allons quand m√™me changer le fichier .env pour initialiser la variable DATABASE_URL pour l'utilisation de PostgreSQL :
```diff
 # DATABASE_URL="mysql://app:!ChangeMe!@127.0.0.1:3306/app?serverVersion=8&charset=utf8mb4"
-DATABASE_URL="postgresql://app:!ChangeMe!@127.0.0.1:5432/app?serverVersion=14&charset=utf8"
+DATABASE_URL="postgresql://127.0.0.1:5432/db?serverVersion=14&charset=utf8"
 ###< doctrine/doctrine-bundle ###
```
Pourquoi l'information doit-elle √™tre dupliqu√©e √† deux endroits diff√©rents ? Parce que sur certaines plates-formes de Cloud, au moment de la compilation, l'URL de la base de donn√©es n'est peut-√™tre pas encore connue mais Doctrine a besoin de conna√Ætre le moteur de la base de donn√©es pour initialiser sa configuration. Ainsi, l'h√¥te, le pseudo et le mot de passe n'ont pas vraiment d'importance.
]

---

.left-column[
  ### A. Base de donn√©es
  ### B. Doctrine ORM
  #### Configurer Doctrine ORM
  #### Cr√©er des classes d'entit√©s
]
.right-column[
Une conf√©rence peut √™tre d√©crite en quelques propri√©t√©s :

* La ville o√π la conf√©rence est organis√©e ;
* L'ann√©e de la conf√©rence ;
* Une option international pour indiquer si la conf√©rence est locale ou internationale (SymfonyLive vs SymfonyCon).

Le **Maker Bundle** peut nous aider √† g√©n√©rer une classe (une classe `Entity`) qui repr√©sente une conf√©rence.

Il est maintenant temps de g√©n√©rer l'entit√© `Conference` :
```sh
symfony console make:entity Conference
```
Cette commande est interactive : elle vous guidera dans le processus d'ajout de tous les champs dont vous avez besoin. Utilisez les r√©ponses suivantes (la plupart d'entre elles sont les valeurs par d√©faut, vous pouvez donc appuyer sur la touche "Entr√©e" pour les utiliser) :
* `city`, `string`, `255`, `no` ;
* `year`, `string`, `4`, `no` ;
* `isInternational`, `boolean`, `no`.

La classe Conference a √©t√© stock√©e sous le namespace `App\Entity\.`

La commande a √©galement g√©n√©r√© une classe de repository Doctrine : `App\Repository\ConferenceRepository.`

]

---

.left-column[
  ### A. Base de donn√©es
  ### B. Doctrine ORM
  #### Configurer Doctrine ORM
  #### Cr√©er des classes d'entit√©s
]
.right-column[
Notez que la classe elle-m√™me est une classe PHP sans aucune r√©f√©rence √† Doctrine. Les attributs sont utilis√©s pour ajouter des m√©tadonn√©es utiles √† Doctrine afin de mapper la classe √† sa table associ√©e dans la base de donn√©es.

Doctrine a ajout√© un attribut `id` pour stocker la cl√© primaire de la ligne dans la table de la base de donn√©es. Cette cl√© `(ORM\Id())` est g√©n√©r√©e automatiquement `(ORM\GeneratedValue())` avec une strat√©gie qui d√©pend du moteur de base de donn√©es.

Maintenant, g√©n√©rez une classe d'entit√© pour les commentaires de la conf√©rence :
```sh
symfony console make:entity Comment
```

Entrez les r√©ponses suivantes :

* `author`, `string`, `255`, `no` ;
* `text`, `text`, `no` ;
* `email`, `string`, `255`, `no` ;
* `createdAt`, `datetime_immutable`, `no`.
]

---

.left-column[
  ### A. Base de donn√©es
  ### B. Doctrine ORM
  #### Configurer Doctrine ORM
  #### Cr√©er des classes d'entit√©s
  #### Lier les entit√©s
]
.right-column[
  
#### Lier les entit√©s
Les deux entit√©s, `Conference` et `Comment`, devraient √™tre li√©es l'une √† l'autre. Une conf√©rence peut avoir z√©ro commentaire ou plus, ce qui s'appelle une relation one-to-many.

Utilisez √† nouveau la commande `make:entity` pour ajouter cette relation √† la classe `Conference` :
```sh
symfony console make:entity Conference
```
Entrez les responses suivantes:
* `comments`, `OneToMany`, `Comment`, `conference`, `no`, `yes`

> üí° Si vous entrez `?` comme r√©ponse pour le type, vous obtiendrez tous les types pris en charge

Tout ce dont vous avez besoin pour g√©rer la relation a √©t√© g√©n√©r√© pour vous. Une fois g√©n√©r√©, le code devient le v√¥tre ; n'h√©sitez pas √† le personnaliser comme vous le souhaitez.

#### Ajouter d'autres propri√©t√©s
Je viens de r√©aliser que nous avons oubli√© d'ajouter une propri√©t√© sur l'entit√© Comment : une photo de la conf√©rence peut √™tre jointe afin d'illustrer un retour d'exp√©rience.

Ex√©cutez √† nouveau make:entity et ajoutez une propri√©t√©/colonne photoFilename de type string. Mais, comme l'ajout d'une photo est facultatif, permettez-lui d'√™tre null :
```sh
symfony console make:entity Comment
```
]

---

.left-column[
  ### A. Base de donn√©es
  ### B. Doctrine ORM
  #### Configurer Doctrine ORM
  #### Cr√©er des classes d'entit√©s
  #### Lier les entit√©s
  #### Migration
]
.right-column[
# Migrer la base de donn√©es
La structure du projet est maintenant enti√®rement d√©crite par les deux classes g√©n√©r√©es.

Ensuite, nous devons cr√©er les tables de base de donn√©es li√©es √† ces entit√©s PHP.

Doctrine Migrations est la solution id√©ale pour cela. Le paquet a d√©j√† √©t√© install√© dans le cadre de la d√©pendance orm.

Une migration est une classe qui d√©crit les changements n√©cessaires pour mettre √† jour un sch√©ma de base de donn√©es, de son √©tat actuel vers le nouveau, en fonction des attributs de l'entit√©. Comme la base de donn√©es est vide pour l'instant, la migration devrait consister en la cr√©ation de deux tables.

Voyons ce que Doctrine g√©n√®re :
```sh
symfony console make:migration
```

Notez le nom du fichier g√©n√©r√© (du genre `migrations/Version20191019083640.php`)

#### Mettre √† jour la base de donn√©es locale
Vous pouvez maintenant ex√©cuter la migration g√©n√©r√©e pour mettre √† jour le sch√©ma de la base de donn√©es locale :
```sh
symfony console doctrine:migrations:migrate
```
]

---
class: center, middle, inverse
# 5. Interface web
---

.left-column[
 ### A. Easy Admin
#### Installation
]
.right-column[
### Configurer une interface d'administration
L'ajout des prochaines conf√©rences √† la base de donn√©es est le travail des admins du projet. Une interface d'administration est une section prot√©g√©e du site web o√π les admins du projet peuvent g√©rer les donn√©es du site web, mod√©rer les commentaires, et plus encore.

Comment pouvons-nous le cr√©er aussi rapidement ? En utilisant un bundle capable de g√©n√©rer une interface d'administration bas√©e sur la structure du projet. EasyAdmin convient parfaitement.
#### Installer des d√©pendances suppl√©mentaires
M√™me si le package webapp a ajout√© automatiquement de nombreux packages utiles, pour des fonctionnalit√©s plus sp√©cifiques, nous devons ajouter d'autres d√©pendances ? Avec Composer. En plus des paquets ¬´ standards ¬ª de Composer, nous travaillerons avec deux types de paquets ¬´ sp√©ciaux ¬ª :

* *Composants Symfony* : Paquets qui impl√©mentent les fonctionnalit√©s de base et les abstractions de bas niveau dont la plupart des applications ont besoin (routage, console, client HTTP, mailer, cache, etc.) ;
* *Bundles Symfony* : Paquets qui ajoutent des fonctionnalit√©s de haut niveau ou fournissent des int√©grations avec des biblioth√®ques tierces (les bundles sont principalement cr√©√©s par la communaut√©).

Ajoutez EasyAdmin comme d√©pendance du projet :
```sh
symfony composer req "admin:^4"
```
`admin` est un alias pour le paquet `easycorp/easyadmin-bundle`. Les alias ne sont pas une fonctionnalit√© interne √† Composer, mais un concept fourni par Symfony pour vous faciliter la vie
]

---

class: middle

.left-column[
### A. Easy Admin
#### Installation
#### Configuration
]
.right-column[
#### Configurer EasyAdmin

Le bundle EasyAdmin cr√©e automatiquement une section d'administration pour votre application bas√©e sur des contr√¥leurs sp√©cifiques.

.center[
  #ü™Ñ
]

Pour d√©buter avec EasyAdmin, commen√ßons par g√©n√©rer un **"tableau de bord d'administration"** qui sera le point d'entr√©e principal pour g√©rer les donn√©es du site.
```sh
symfony console make:admin:dashboard
```

Avec les r√©ponses par d√©faut, cr√©e le contr√¥leur `src/Controller/Admin/DashboardController.php`

.info[
  üóí Par convention, les contr√¥leurs d'administration sont stock√©s dans leur propre espace de nom `App\Controller\Admin`.
]
]

---

class: middle
.left-column[
### A. Easy Admin
#### Installation
#### Configuration
]
.right-column[

**Acc√©dez √† l'interface d'administration** g√©n√©r√©e gr√¢ce √† l'URL `/admin` telle que configur√©e par la m√©thode `index()` (vous pouvez modifier l'URL comme bon vous semble) :

.pull-left[
<img src="img/easy-admin-empty.png" alt="Easy admin empty" width="430px">
]
.pull-right[
  #.center[üöÄ]
Boom ! Nous avons une belle interface d'administration, pr√™te √† √™tre adapt√©e √† nos besoins.
]
]

---

.left-column[
### A. Easy Admin
#### Installation
#### Configuration
#### G√©nerer un CRUD
]
.right-column[
L'√©tape suivante consiste √† cr√©er des contr√¥leurs pour g√©rer les conf√©rences et les commentaires.

Dans le contr√¥leur du tableau de bord, vous avez peut-√™tre remarqu√© la m√©thode `configureMenuItems()` qui contient un commentaire √† propos de l'ajout de liens aux "CRUDs". "CRUD" est un acronyme pour "Create, Read, Update and Delete", les quatre op√©rations de base que vous allez effectuer sur une entit√©. C'est exactement ce que nous voulons que notre page d'administration fasse pour nous. EasyAdmin facilite encore plus les choses en prenant en charge les fonctionnalit√©s de filtre et de recherche.

G√©n√©rons un `CRUD` pour les conf√©rences :
```sh
symfony console make:admin:crud
```
S√©lectionnez 1 pour cr√©er une interface d'administration pour les conf√©rences et utiliser les valeurs par d√©faut pour les autres questions. Le fichier suivant devrait √™tre g√©n√©r√© :
`src/Controller/Admin/ConferenceCrudController.php`
Faites la m√™me chose pour les commentaires :

```sh
symfony console make:admin:crud
```
]

---

.left-column[
### A. Easy Admin
#### Installation
#### Configuration
#### G√©nerer un CRUD
#### Lier un CRUD au Dashboard
]
.right-column[
La derni√®re √©tape consiste √† relier les CRUDs d'administration des conf√©rences et des commentaires au tableau de bord:
```diff
# src/Controller/Admin/DashboardController.php
 namespace App\Controller\Admin;

+use App\Entity\Comment;
+use App\Entity\Conference;
 use EasyCorp\Bundle\EasyAdminBundle\Config\Dashboard;

@@ ...
    public function configureMenuItems(): iterable
    {
-        yield MenuItem::linkToDashboard('Dashboard', 'fa fa-home');
-        // yield MenuItem::linkToCrud('The Label', 'fas fa-list', EntityClass::class);
+        yield MenuItem::linktoRoute('Back to the website', 'fas fa-home', 'homepage');
+        yield MenuItem::linkToCrud('Conferences', 'fas fa-map-marker-alt', Conference::class);
+        yield MenuItem::linkToCrud('Comments', 'fas fa-comments', Comment::class);
    }
```
Nous avons surcharg√© la m√©thode `configureMenuItems()` pour ajouter les √©l√©ments de menu avec les ic√¥nes ad√©quates pour les conf√©rences et les commentaires, et pour ajouter un lien de retour vers la page d'accueil du site.

EasyAdmin expose une API pour faciliter les liaisons avec les CRUDs des entit√©s via la m√©thode `MenuItem::linkToRoute()`.

]

---

.left-column[
### A. Easy Admin
#### Installation
#### Configuration
#### G√©nerer un CRUD
#### Lier un CRUD au Dashboard
]
.right-column[
Le tableau de bord principal est vide pour le moment. C'est ici que vous pouvez afficher certaines statistiques, ou n'importe quelle information pertinente. Comme nous n'avons rien d'important √† y afficher, redirigeons cette page vers la liste des conf√©rences :
```diff
# src/Controller/Admin/DashboardController.php
 use EasyCorp\Bundle\EasyAdminBundle\Controller\AbstractDashboardController;
+use EasyCorp\Bundle\EasyAdminBundle\Router\AdminUrlGenerator;
 use Symfony\Component\HttpFoundation\Response;

 @@ ...
    public function index(): Response
    {
-        return parent::index();
+        $routeBuilder = $this->container->get(AdminUrlGenerator::class);
+        $url = $routeBuilder->setController(ConferenceCrudController::class)->generateUrl();
+
+        return $this->redirect($url);
```
]

---

.left-column[
### A. Easy Admin
#### Installation
#### Configuration
#### G√©nerer un CRUD
#### Lier un CRUD au 
#### Des entit√©s Stringable
]
.right-column[
Quand nous affichons les relations entre les entit√©s (la conf√©rence li√©e √† un commentaire), EasyAdmin essaie d'utiliser la repr√©sentation textuelle de la conf√©rence. Par d√©faut, il s'appuie sur une convention qui utilise le nom de l'entit√© et la cl√© primaire (par exemple `Conference #1`) si l'entit√© ne d√©finit pas la m√©thode "magique" `__toString()`. Pour rendre l'affichage plus parlant, ajoutez cette m√©thode sur la classe `Conference`.

La m√©thode __toString() fait partie du contrat de l'interface Stringable. Nous devons l'impl√©menter pour respecter le contrat sur nos entit√©s.

```diff
# src/Entity/Conference.php

- class Conference
+ class Conference implements \Stringable

@@ ....

+    public function __toString(): string
+    {
+        return $this->city.' '.$this->year;
+    }
+
     public function getId(): ?int
     {
```

]

---

.left-column[
### A. Easy Admin
#### Installation
#### Configuration
#### G√©nerer un CRUD
#### Lier un CRUD au 
#### Des entit√©s Stringable
]
.right-column[
Faites de m√™me pour la classe `Comment` :

```diff
# src/Entity/Comment.php

- class Comment
+ class Comment implements \Stringable

@@ ....

+    public function __toString(): string
+    {
+        return (string) $this->getEmail();
+    }
+
     public function getId(): ?int
     {
```
Vous pouvez maintenant ajouter/modifier/supprimer des conf√©rences directement depuis l'interface d'administration. Jouez avec et ajoutez au moins une conf√©rence.

Ajoutez quelques commentaires sans photos. R√©glez la date manuellement pour l'instant ; nous remplirons la colonne createdAt automatiquement dans une √©tape ult√©rieure.
]

---

.left-column[
### A. Easy Admin
#### Installation
#### Configuration
#### G√©nerer un CRUD
#### Lier un CRUD au 
#### Des entit√©s Stringable
#### Personnaliser EasyAdmin
]
.right-column[
L'interface d'administration par d√©faut fonctionne bien, mais elle peut √™tre personnalis√©e de plusieurs fa√ßons pour am√©liorer son utilisation. Faisons quelques changements simples pour montrer quelques possibilit√©s :
```diff
# src/Controller/Admin/CommentCrudController.php

         return Comment::class;
     }

-    /*
+    public function configureCrud(Crud $crud): Crud
+    {
+        return $crud
+            ->setEntityLabelInSingular('Conference Comment')
+            ->setEntityLabelInPlural('Conference Comments')
+            ->setSearchFields(['author', 'text', 'email'])
+            ->setDefaultSort(['createdAt' => 'DESC'])
+        ;
+    }
+
+    public function configureFilters(Filters $filters): Filters
+    {
+        return $filters
+            ->add(EntityFilter::new('conference'))
+        ;
+    }
+
```
]

---

.left-column[
### A. Easy Admin
#### Installation
#### Configuration
#### G√©nerer un CRUD
#### Lier un CRUD au 
#### Des entit√©s Stringable
#### Personnaliser EasyAdmin
]
.right-column[
```diff
# src/Controller/Admin/CommentCrudController.php

     public function configureFields(string $pageName): iterable
     {
-        return [
-            IdField::new('id'),
-            TextField::new('title'),
-            TextEditorField::new('description'),
-        ];
+        yield AssociationField::new('conference');
+        yield TextField::new('author');
+        yield EmailField::new('email');
+        yield TextareaField::new('text')
+            ->hideOnIndex()
+        ;
+        yield TextField::new('photoFilename')
+            ->onlyOnIndex()
+        ;
+
+        $createdAt = DateTimeField::new('createdAt')->setFormTypeOptions([
+            'html5' => true,
+            'years' => range(date('Y'), date('Y') + 5),
+            'widget' => 'single_text',
+        ]);
+        if (Crud::PAGE_EDIT === $pageName) {
+            yield $createdAt->setFormTypeOption('disabled', true);
+        } else {
+            yield $createdAt;
+        }
     }
-    */
```
]

---

.left-column[
### A. Easy Admin
#### Installation
#### Configuration
#### G√©nerer un CRUD
#### Lier un CRUD au 
#### Des entit√©s Stringable
#### Personnaliser EasyAdmin
]
.right-column[
  Pour personnaliser la section `Commentaire`, lister les champs de mani√®re explicite dans la m√©thode `configureFields()` nous permet de les ordonner comme nous le souhaitons. Certains champs b√©n√©ficient d'une configuration suppl√©mentaire, comme masquer le champ texte sur la page d'index.

Les m√©thodes `configureFilters()` d√©finissent quels filtres apparaissent au dessus du champ de recherche.

.center[<img src="img/easy-admin-filter.png" alt="Easy admin filter" width="350px" />]

Ces personnalisations ne sont qu'une petite introduction aux possibilit√©s offertes par EasyAdmin.

Jouez avec l'interface d'administration, filtrez les commentaires par conf√©rence, ou recherchez des commentaires par email par exemple. Le seul probl√®me, c'est que n'importe qui peut acc√©der √† cette interface. Ne vous inqui√©tez pas, nous la s√©curiserons dans une prochaine √©tape.
]

---

.left-column[
### A. Easy Admin
### B. Twig
#### Utiliser Twig pour les templates
]
.right-column[
Tout est maintenant en place pour cr√©er la premi√®re version de l'interface du site. On ne la fera pas jolie pour le moment, seulement fonctionnelle.

Vous vous souvenez de l'√©chappement de caract√®res que nous avons d√ª faire dans le contr√¥leur, pour l'easter egg, afin d'√©viter les probl√®mes de s√©curit√© ? Nous n'utiliserons pas PHP pour nos templates pour cette raison. √Ä la place, nous utiliserons **Twig**. En plus de g√©rer l'√©chappement de caract√®res, Twig apporte de nombreuses fonctionnalit√©s int√©ressantes, comme l'h√©ritage des mod√®les.

#### Utiliser Twig pour les templates
Toutes les pages du site Web suivront le m√™me mod√®le de mise en page, la m√™me structure HTML de base. Lors de l'installation de Twig, un r√©pertoire `templates/` a √©t√© cr√©√© automatiquement, ainsi qu'un exemple de structure de base dans `base.html.twig`.

```html
<!DOCTYPE html>
<html>
    <head>
        ...
        {%block 'stylesheets' %}{{ encore_entry_link_tags('app') }}{% endblock %}
        {%block 'javascripts' %}{{ encore_entry_script_tags('app') }}{% endblock %}
    </head>
    <body>
        {% block body %}{% endblock %}
    </body>
</html>
```
Un mod√®le peut d√©finir des `blocks`. Un `block` est un emplacement o√π les *templates enfants*, qui *√©tendent* le mod√®le, ajoutent leur contenu.
]

---

.left-column[
### A. Easy Admin
### B. Twig
#### Utiliser Twig pour les templates
]
.right-column[
Cr√©ons un template pour la page d'accueil du projet dans `templates/conference/index.html.twig`.
```twig
{% extends 'base.html.twig' %}

{% block title %}Conference Guestbook{% endblock %}

{% block body %}
    <h2>Give your feedback!</h2>

    {% for conference in conferences %}
        <h4>{{ conference }}</h4>
    {% endfor %}
{% endblock %}
```
Le template *√©tend* (ou `extends`) `base.html.twig` et red√©finit les blocs `title` et `body`.

La notation `{% %}` dans un template indique des actions et des √©l√©ments de structure.

La notation `{{ }}` est utilis√©e pour afficher quelque chose. `{{ conference }}` affiche la repr√©sentation de la conf√©rence (le r√©sultat de l'appel √† la m√©thode `__toString` de l'objet `Conference`).
]

---

.left-column[
### A. Easy Admin
### B. Twig
#### Utiliser Twig pour les templates
#### Utiliser Twig dans un contr√¥leur
]
.right-column[
Mettez √† jour le contr√¥leur pour g√©n√©rer le contenu du template Twig :
```diff
# src/Controller/ConferenceController.php

+use App\Repository\ConferenceRepository;
+use Twig\Environment;

 class ConferenceController extends AbstractController
 {
     #[Route('/', name: 'homepage')]
-    public function index(): Response
+    public function index(Environment $twig, ConferenceRepository $conferenceRepository): Response
     {
-        return new Response(<<<EOF
-            <html>
-                <body><img src="/images/under-construction.gif" /></body>
-            </html>
-            EOF
-        );
+        return new Response($twig->render('conference/index.html.twig', [
+            'conferences' => $conferenceRepository->findAll(),
+        ]));
```
Il se passe beaucoup de choses ici.



]

---

.left-column[
### A. Easy Admin
### B. Twig
#### Utiliser Twig pour les templates
#### Utiliser Twig dans un contr√¥leur
]
.right-column[
Pour pouvoir g√©n√©rer le contenu du template, nous avons besoin de l'objet `Environment` de Twig (le point d'entr√©e principal de Twig). 

> üëÄ Notez que nous demandons l'instance Twig en sp√©cifiant son type dans la m√©thode du contr√¥leur. Symfony est assez intelligent pour savoir comment injecter le bon objet. 

> Nous avons √©galement besoin du *repository* des conf√©rences pour r√©cup√©rer toutes les conf√©rences depuis la base de donn√©es.

Dans le code du contr√¥leur, la m√©thode `render()` g√©n√®re le rendu du template et lui passe un tableau de variables. Nous passons la liste des objets `Conference` dans une variable `conferences`.

Un contr√¥leur est une classe PHP standard. Nous n'avons m√™me pas besoin d'√©tendre la classe `AbstractController` si nous voulons √™tre explicites sur nos d√©pendances. Vous pouvez donc supprimer l'h√©ritage (mais ne le faites pas, car nous utiliserons les raccourcis qu'il fournit dans les prochaines √©tapes).
]

---

.left-column[
### A. Easy Admin
### B. Twig
#### Utiliser Twig pour les templates
#### Utiliser Twig dans un contr√¥leur
#### Cr√©er la page d'une conf√©rence
]
.right-column[
Chaque conf√©rence devrait avoir une page d√©di√©e √† l'affichage de ses commentaires. L'ajout d'une nouvelle page consiste √† ajouter un contr√¥leur, √† d√©finir une route et √† cr√©er le template correspondant.

Ajoutez une m√©thode show() dans le fichier `src/Controller/ConferenceController.php` :
```diff
+use App\Entity\Conference;
+use App\Repository\CommentRepository;
 use App\Repository\ConferenceRepository;

@@ ...
     }

+
+    #[Route('/conference/{id}', name: 'conference')]
+    public function show(Environment $twig, Conference $conference, CommentRepository $commentRepository): Response
+    {
+        return new Response($twig->render('conference/show.html.twig', [
+            'conference' => $conference,
+            'comments' => $commentRepository->findBy(['conference' => $conference], ['createdAt' => 'DESC']),
+        ]));
+    }
```
Cette m√©thode a un comportement particulier que nous n'avons pas encore vu. Nous demandons qu'une instance de `Conference` soit inject√©e dans la m√©thode. Mais il y en a peut-√™tre beaucoup dans la base de donn√©es. Symfony est capable de d√©terminer celle que vous voulez en se basant sur l'`{id}` pass√© dans le chemin de la requ√™te (`id` √©tant la cl√© primaire de la table `conference` dans la base de donn√©es).
]

---

.left-column[
### A. Easy Admin
### B. Twig
#### Utiliser Twig pour les templates
#### Utiliser Twig dans un contr√¥leur
#### Cr√©er la page d'une conf√©rence
]
.right-column[
La r√©cup√©ration des commentaires associ√©s √† la conf√©rence peut se faire via la m√©thode `findBy()`, qui prend un crit√®re comme premier argument.

La derni√®re √©tape consiste √† cr√©er le fichier `templates/conference/show.html.twig` :
```twig
{% extends 'base.html.twig' %}

{% block title %}Conference Guestbook - {{ conference }}{% endblock %}

{% block body %}
    <h2>{{ conference }} Conference</h2>

    {% if comments|length > 0 %}
        {% for comment in comments %}
            {% if comment.photofilename %}
                <img src="{{ asset('uploads/photos/' ~ comment.photofilename) }}" />
            {% endif %}

            <h4>{{ comment.author }}</h4>
            <small>
                {{ comment.createdAt|format_datetime('medium', 'short') }}
            </small>

            <p>{{ comment.text }}</p>
        {% endfor %}
    {% else %}
        <div>No comments have been posted yet for this conference.</div>
    {% endif %}
{% endblock %}
```
]

---

.left-column[
### A. Easy Admin
### B. Twig
#### Utiliser Twig pour les templates
#### Utiliser Twig dans un contr√¥leur
#### Cr√©er la page d'une conf√©rence
]
.right-column[
Dans ce template, nous utilisons le symbole `|` pour appeler les filtres Twig. Un filtre transforme une valeur. `comments|length` retourne le nombre de commentaires et `comment.createdAt|format_datetime('medium', 'short')` affiche la date dans un format lisible par l'internaute.

Essayez d'afficher la "premi√®re" conf√©rence en naviguant vers `/conference/1`, et constatez l'erreur suivante :

.center[<img src="img/intl-twig-error.png" width="350px">]

L'erreur vient du filtre `format_datetime`, qui ne fait pas partie du noyau de Twig. Le message d'erreur vous donne un indice sur le paquet √† installer pour r√©soudre le probl√®me :
```sh
symfony composer req "twig/intl-extra:^3"
```
Maintenant la page fonctionne correctement.
]

---

.left-column[
### A. Easy Admin
### B. Twig
#### Utiliser Twig pour les templates
#### Utiliser Twig dans un contr√¥leur
#### Cr√©er la page d'une conf√©rence
#### Lier des pages entre elles
]
.right-column[
La toute derni√®re √©tape pour terminer notre premi√®re version de l'interface est de rendre les pages de la conf√©rence accessibles depuis la page d'accueil :
```diff
# templates/conference/index.html.twig

     {% for conference in conferences %}
         <h4>{{ conference }}</h4>
+        <p>
+            <a href="/conference/{{ conference.id }}">View</a>
+        </p>
     {% endfor %}
 {% endblock %}

```
Mais coder un chemin en dur est une mauvaise id√©e pour plusieurs raisons. La raison principale est que si vous transformez le chemin (de /conference/{id} en /conferences/{id} par exemple), tous les liens doivent √™tre mis √† jour manuellement.

Utilisez plut√¥t la fonction Twig path() avec le nom de la route :
```diff
# templates/conference/index.html.twig

         <p>
-            <a href="/conference/{{ conference.id }}">View</a>
+            <a href="{{ path('conference', { id: conference.id }) }}">View</a>
         </p>
     {% endfor %}
```
La fonction path() g√©n√®re le chemin d'acc√®s vers une page √† l'aide du nom de la route. Les valeurs des param√®tres dynamiques de la route sont transmises sous la forme d'un objet Twig.

]

---

.left-column[
### A. Easy Admin
### B. Twig
#### Utiliser Twig pour les templates
#### Utiliser Twig dans un contr√¥leur
#### Cr√©er la page d'une conf√©rence
#### Lier des pages entre elles
#### Paginer les commentaires
]
.right-column[
Avec des milliers de personnes pr√©sentes, on peut s'attendre √† un nombre important de commentaires. Si nous les affichons tous sur une seule page, elle deviendra rapidement √©norme.

Cr√©ez une m√©thode getCommentPaginator() dans CommentRepository. Cette m√©thode renvoie un Paginator de commentaires bas√© sur une conf√©rence et un d√©calage (o√π commencer) :
```diff
# src/Repository/CommentRepository.php
+use App\Entity\Conference;
+use Doctrine\ORM\Tools\Pagination\Paginator;
...

 class CommentRepository extends ServiceEntityRepository
 {
+    public const PAGINATOR_PER_PAGE = 2;
+
...

+    public function getCommentPaginator(Conference $conference, int $offset): Paginator
+    {
+        $query = $this->createQueryBuilder('c')
+            ->andWhere('c.conference = :conference')
+            ->setParameter('conference', $conference)
+            ->orderBy('c.createdAt', 'DESC')
+            ->setMaxResults(self::PAGINATOR_PER_PAGE)
+            ->setFirstResult($offset)
+            ->getQuery()
+        ;
+
+        return new Paginator($query);
+    }
```
]

---

.left-column[
### A. Easy Admin
### B. Twig
#### Utiliser Twig pour les templates
#### Utiliser Twig dans un contr√¥leur
#### Cr√©er la page d'une conf√©rence
#### Lier des pages entre elles
#### Paginer les commentaires
]
.right-column[
Nous avons fix√© le nombre maximum de commentaires par page √† 2 pour faciliter les tests.

Pour g√©rer la pagination dans le template, transmettez √† Twig le Doctrine Paginator au lieu de la Doctrine Collection :
```diff
# src/Controller/ConferenceController.php

+use Symfony\Component\HttpFoundation\Request;
...

-    public function show(Environment $twig, Conference $conference, CommentRepository $commentRepository): Response
+    public function show(Request $request, Environment $twig, Conference $conference, CommentRepository $commentRepository): Response
     {
+        $offset = max(0, $request->query->getInt('offset', 0));
+        $paginator = $commentRepository->getCommentPaginator($conference, $offset);
+
         return new Response($twig->render('conference/show.html.twig', [
             'conference' => $conference,
-            'comments' => $commentRepository->findBy(['conference' => $conference], ['createdAt' => 'DESC']),
+            'comments' => $paginator,
+            'previous' => $offset - CommentRepository::PAGINATOR_PER_PAGE,
+            'next' => min(count($paginator), $offset + CommentRepository::PAGINATOR_PER_PAGE),
         ]));
     }
```
Le contr√¥leur r√©cup√®re la valeur du d√©calage (offset) depuis les param√®tres de l'URL ($request->query) sous forme d'entier (getInt()). Par d√©faut, sa valeur sera 0 si le param√®tre n'est pas d√©fini.
]

---

.left-column[
### A. Easy Admin
### B. Twig
#### Utiliser Twig pour les templates
#### Utiliser Twig dans un contr√¥leur
#### Cr√©er la page d'une conf√©rence
#### Lier des pages entre elles
#### Paginer les commentaires
]
.right-column[
Les d√©calages pr√©c√©dent et suivant sont calcul√©s sur la base de toutes les informations que nous avons re√ßues du paginateur.

Enfin, mettez √† jour le template pour ajouter des liens vers les pages suivantes et pr√©c√©dentes :

```diff
# templates/conference/show.html.twig

     {% if comments|length > 0 %}
+        <div>There are {{ comments|length }} comments.</div>
+
...

             <p>{{ comment.text }}</p>
         {% endfor %}
+
+        {% if previous >= 0 %}
+            <a href="{{ path('conference', { id: conference.id, offset: previous }) }}">Previous</a>
+        {% endif %}
+        {% if next < comments|length %}
+            <a href="{{ path('conference', { id: conference.id, offset: next }) }}">Next</a>
+        {% endif %}
     {% else %}
```
Vous devriez maintenant pouvoir naviguer dans les commentaires avec les liens "Previous" et "Next" :
]

---

.left-column[
### A. Easy Admin
### B. Twig
#### Utiliser Twig pour les templates
#### Utiliser Twig dans un contr√¥leur
#### Cr√©er la page d'une conf√©rence
#### Lier des pages entre elles
#### Paginer les commentaires
#### Optimiser le contr√¥leur
]
.right-column[
Vous avez peut-√™tre remarqu√© que les deux m√©thodes pr√©sentes dans ConferenceController prennent un environnement Twig comme argument. Au lieu de l'injecter dans chaque m√©thode, appelons la m√©thode render() de la classe parente :

```diff
-use Twig\Environment;

 class ConferenceController extends AbstractController
 {
     #[Route('/', name: 'homepage')]
-    public function index(Environment $twig, ConferenceRepository $conferenceRepository): Response
+    public function index(ConferenceRepository $conferenceRepository): Response
     {
-        return new Response($twig->render('conference/index.html.twig', [
+        return $this->render('conference/index.html.twig', [
             'conferences' => $conferenceRepository->findAll(),
-        ]));
+        ]);
     }
```
]

---

.left-column[
### A. Easy Admin
### B. Twig
#### Utiliser Twig pour les templates
#### Utiliser Twig dans un contr√¥leur
#### Cr√©er la page d'une conf√©rence
#### Lier des pages entre elles
#### Paginer les commentaires
#### Optimiser le contr√¥leur
]
.right-column[
  ```diff

     #[Route('/conference/{id}', name: 'conference')]
-    public function show(Request $request, Environment $twig, Conference $conference, CommentRepository $commentRepository): Response
+    public function show(Request $request, Conference $conference, CommentRepository $commentRepository): Response
     {
         $offset = max(0, $request->query->getInt('offset', 0));
         $paginator = $commentRepository->getCommentPaginator($conference, $offset);

-        return new Response($twig->render('conference/show.html.twig', [
+        return $this->render('conference/show.html.twig', [
             'conference' => $conference,
             'comments' => $paginator,
             'previous' => $offset - CommentRepository::PAGINATOR_PER_PAGE,
             'next' => min(count($paginator), $offset + CommentRepository::PAGINATOR_PER_PAGE),
-        ]));
+        ]);
     }
```

> üì¨ Commitez notre travail via `git commit -am "Twig"`
]

---
class: center, middle, inverse
# 5. Les √©venements
---

.left-column[
### A. √âcouter les √©v√©nements
#### Ajouter un en-t√™te au site web
]
.right-column[
Il manque une barre de navigation au layout actuel pour revenir √† la page d'accueil ou pour passer d'une conf√©rence √† l'autre.
#### Ajouter un en-t√™te au site web

Tout ce qui doit √™tre affich√© sur toutes les pages web, comme un en-t√™te, doit faire partie du layout de base principal :

```diff
     <body>
+        <header>
+            <h1><a href="{{ path('homepage') }}">Guestbook</a></h1>
+            <ul>
+            {% for conference in conferences %}
+                <li><a href="{{ path('conference', { id: conference.id }) }}">{{ conference }}</a></li>
+            {% endfor %}
+            </ul>
+            <hr />
+        </header>
         {% block body %}{% endblock %}
     </body>
```
L'ajout de ce code au layout signifie que tous les templates qui l'√©tendent doivent d√©finir une variable conferences, cr√©√©e et transmise par leurs contr√¥leurs.
]

---

.left-column[
### A. √âcouter les √©v√©nements
#### Ajouter un en-t√™te au site web
]
.right-column[
Comme nous n'avons que deux contr√¥leurs, vous pourriez proc√©der comme ceci (ne modifiez pas votre code car nous verrons tr√®s vite une meilleure fa√ßon de faire) :
```diff
# 
     #[Route('/conference/{id}', name: 'conference')]
-    public function show(Request $request, Conference $conference, CommentRepository $commentRepository): Response
+    public function show(Request $request, Conference $conference, CommentRepository $commentRepository, ConferenceRepository $conferenceRepository): Response
     {
         $offset = max(0, $request->query->getInt('offset', 0));
         $paginator = $commentRepository->getCommentPaginator($conference, $offset);

         return $this->render('conference/show.html.twig', [
+            'conferences' => $conferenceRepository->findAll(),
            ...
         ]);
```
Imaginez devoir mettre √† jour des dizaines de contr√¥leurs. Et faire la m√™me chose sur tous les nouveaux. Ce n'est pas tr√®s pratique. Il doit y avoir un meilleur moyen.

Twig a la notion de variables globales. Une variable globale est disponible dans tous les templates g√©n√©r√©s. Vous pouvez les d√©finir dans un fichier de configuration, mais cela ne fonctionne que pour les valeurs statiques. Pour ajouter toutes les conf√©rences comme variable globale Twig, nous allons cr√©er un listener.]

---

.left-column[
### A. √âcouter les √©v√©nements
#### Ajouter un en-t√™te au site web
#### D√©couvrir les √©v√©nements Symfony
]
.right-column[
**Symfony int√®gre un composant Event Dispatcher.** Un dispatcher r√©partit certains √©v√©nements √† des moments pr√©cis que les listeners peuvent √©couter. Les listeners sont des hooks dans le c≈ìur du framework.

Par exemple, certains √©v√©nements vous permettent d'interagir avec le cycle de vie des requ√™tes HTTP. Pendant le traitement d'une requ√™te, le dispatcher r√©partit les √©v√©nements lorsqu'une requ√™te a √©t√© cr√©√©e, lorsqu'un contr√¥leur est sur le point d'√™tre ex√©cut√©, lorsqu'une r√©ponse est pr√™te √† √™tre envoy√©e, ou lorsqu'une exception a √©t√© lev√©e. Un listener peut √©couter un ou plusieurs √©v√©nements et ex√©cuter une logique bas√©e sur le contexte de l'√©v√©nement.

Les √©v√©nements sont des points d'extension bien d√©finis qui rendent le framework plus g√©n√©rique et extensible. De nombreux composants Symfony tels que Security, Messenger, Workflow ou Mailer les utilisent largement.

Un autre exemple int√©gr√© d'√©v√©nements et de listeners en action est le cycle de vie d'une commande : vous pouvez cr√©er un listener pour ex√©cuter du code avant n'importe quelle commande.

Tout paquet ou bundle peut √©galement d√©clencher ses propres √©v√©nements pour rendre son code extensible.

Pour √©viter d'avoir un fichier de configuration qui d√©crit les √©v√©nements qu'un listener veut √©couter, cr√©ez un subscriber. Un subscriber est un listener avec une m√©thode statique `getSubscribedEvents()` qui retourne sa configuration. Ceci permet aux subscribers d'√™tre enregistr√©s automatiquement dans le dispatcher Symfony.


]
---

.left-column[
### A. √âcouter les √©v√©nements
#### Ajouter un en-t√™te au site web
#### D√©couvrir les √©v√©nements Symfony
#### Impl√©menter un subscriber
]
.right-column[
Vous connaissez la chanson par c≈ìur maintenant, utilisez le Maker Bundle pour g√©n√©rer un subscriber :
```sh
symfony console make:subscriber TwigEventSubscriber
```

La commande vous demande quel √©v√©nement vous voulez √©couter. Choisissez l'√©v√©nement `Symfony\Component\HttpKernel\Event\ControllerEvent` qui est envoy√© juste avant l'appel d'un contr√¥leur. C'est le meilleur moment pour injecter la variable globale conferences afin que Twig y ait acc√®s lorsque le contr√¥leur g√©n√©rera le template. Mettez votre subscriber √† jour comme suit :
```diff
 class TwigEventSubscriber implements EventSubscriberInterface
 {

+    public function __construct(
+        private Environment $twig, 
+        private ConferenceRepository $conferenceRepository
+    ) { }
+
     public function onControllerEvent(ControllerEvent $event): void
     {
-        // ...
+        $this->twig->addGlobal('conferences', $this->conferenceRepository->findAll());
     }
```

Maintenant, vous pouvez ajouter autant de contr√¥leurs que vous le souhaitez : la variable `conferences` sera toujours disponible dans Twig.
  
> .info[üóí Nous parlerons d'une alternative bien plus performante dans une prochaine √©tape.]
]
---

.left-column[
### A. √âcouter les √©v√©nements
#### Ajouter un en-t√™te au site web
#### D√©couvrir les √©v√©nements Symfony
#### Impl√©menter un subscriber
#### Trier les conf√©rences par ann√©e et par ville
]
.right-column[
  Le tri de la liste des conf√©rences par ann√©e peut faciliter la navigation. Nous pourrions cr√©er notre propre m√©thode pour r√©cup√©rer et trier toutes les conf√©rences, mais nous allons plut√¥t remplacer l'impl√©mentation par d√©faut de la m√©thode findAll(), afin que le tri s'applique partout :

```diff
+    public function findAll(): array
+    {
+        return $this->findBy([], ['year' => 'ASC', 'city' => 'ASC']);
+    }
+
     public function save(Conference $entity, bool $flush = false): void
     {
         $this->getEntityManager()->persist($entity);
```
√Ä la fin de cette √©tape, le site web devrait ressembler √† ceci :

.center[<img src="img/header.png" alt="header" width="350px" />]

  > üì¨ Commitez notre travail via `git commit -am "√âcouter les √©v√©nements"`
]
---

.left-column[
### A. √âcouter les √©v√©nements
### B. G√©rer le cycle de vie des objets Doctrine
#### D√©finir des lifecycle callbacks
]
.right-column[
Lors de la cr√©ation d'un nouveau commentaire, ce serait bien si la date createdAt √©tait automatiquement d√©finie √† la date et √† l'heure courantes.

Doctrine a diff√©rentes fa√ßons de manipuler les objets et leurs propri√©t√©s pendant leur cycle de vie (avant la cr√©ation de la ligne dans la base de donn√©es, apr√®s la mise √† jour de la ligne, etc.).

Lorsque le comportement n'a besoin d'aucun service et ne doit √™tre appliqu√© qu'√† un seul type d'entit√©, d√©finissez un callback dans la classe entit√© :

```diff
 #[ORM\Entity(repositoryClass: CommentRepository::class)]
+#[ORM\HasLifecycleCallbacks]
 class Comment
 {
     #[ORM\Id]
@@ -91,6 +92,12 @@ class Comment
         return $this;
     }

+    #[ORM\PrePersist]
+    public function setCreatedAtValue()
+    {
+        $this->createdAt = new \DateTimeImmutable();
+    }
+
     public function getConference(): ?Conference
```

L'√©v√©nement `ORM\PrePersist` est d√©clench√© lorsque l'objet est enregistr√© dans la base de donn√©es pour la toute premi√®re fois. Lorsque cela se produit, la m√©thode `setCreatedAtValue()` est appel√©e et la date et l'heure courantes sont utilis√©es pour la valeur de la propri√©t√© createdAt.
]
---

.left-column[
### A. √âcouter les √©v√©nements
### B. G√©rer le cycle de vie des objets Doctrine
#### D√©finir des lifecycle callbacks
#### Ajouter des slugs aux conf√©rences
]
.right-column[
Les URLs des conf√©rences n'ont pas de sens : /conference/1. Plus important encore, ils d√©pendent d'un d√©tail d'impl√©mentation (la cl√© primaire de la base de donn√©es est r√©v√©l√©e).

Pourquoi ne pas plut√¥t utiliser des URLs telles que /conference/paris-2020 ? Ce serait plus joli. paris-2020, c'est ce que l'on appelle le slug de la conf√©rence.

Ajoutez une nouvelle propri√©t√© slug pour les conf√©rences (une cha√Æne non nulle de 255 caract√®res) :
```sh
symfony console make:entity Conference
```

Cr√©ez un fichier de migration pour ajouter la nouvelle colonne et Et ex√©cutez cette nouvelle migration.

‚ùó Vous avez une erreur ? C'√©tait pr√©vu. Pourquoi ? Parce que nous avons demand√© que le slug ne soit pas null, et que les entr√©es existantes dans la base de donn√©es de la conf√©rence obtiendront une valeur null lorsque la migration sera ex√©cut√©e. Corrigeons cela en ajustant la migration.
```diff
     public function up(Schema $schema): void
     {
         // this up() migration is auto-generated, please modify it to your needs
-        $this->addSql('ALTER TABLE conference ADD slug VARCHAR(255) NOT NULL');
+        $this->addSql('ALTER TABLE conference ADD slug VARCHAR(255)');
+        $this->addSql("UPDATE conference SET slug=CONCAT(LOWER(city), '-', year)");
+        $this->addSql('ALTER TABLE conference ALTER COLUMN slug SET NOT NULL');
     }
```

L'astuce ici est d'ajouter la colonne et de lui permettre d'√™tre null, puis de d√©finir une valeur non null pour le slug, et enfin, de changer la colonne de slug pour ne plus permettre null.

La migration devrait fonctionner maintenant.
]
---

.left-column[
### A. √âcouter les √©v√©nements
### B. G√©rer le cycle de vie des objets Doctrine
#### D√©finir des lifecycle callbacks
#### Ajouter des slugs aux conf√©rences
]
.right-column[
√âtant donn√© que l'application utilisera bient√¥t les slugs pour trouver chaque conf√©rence, ajustons l'entit√© Conference pour s'assurer que les valeurs des slugs soient uniques dans la base de donn√©es :

```diff
+use Symfony\Bridge\Doctrine\Validator\Constraints\UniqueEntity;

 #[ORM\Entity(repositoryClass: ConferenceRepository::class)]
+#[UniqueEntity('slug')]
 class Conference
 {
     #[ORM\Id]

@@ ...

     #[ORM\OneToMany(mappedBy: 'conference', targetEntity: Comment::class, orphanRemoval: true)]
     private Collection $comments;

-    #[ORM\Column(length: 255)]
+    #[ORM\Column(type: 'string', length: 255, unique: true)]
     private ?string $slug = null;
```

üíÉ Comme vous l'aurez devin√©, nous devons ex√©cuter la danse de la migration


]
---

.left-column[
### A. √âcouter les √©v√©nements
### B. G√©rer le cycle de vie des objets Doctrine
#### D√©finir des lifecycle callbacks
#### Ajouter des slugs aux conf√©rences
#### G√©n√©rer des slugs
]
.right-column[
G√©n√©rer un *slug* qui se lit bien dans une URL (o√π tout ce qui n'est pas des caract√®res **ASCII** doit √™tre encod√©) est une t√¢che difficile, surtout pour les langues autres que l'anglais. Comment convertir √© en e par exemple ?

Au lieu de r√©inventer la roue, utilisons le composant *Symfony String*, qui facilite la manipulation des cha√Ænes et fournit un slugger.

Dans la classe Conference, ajoutez une m√©thode `computeSlug()`, qui calcule le slug en fonction des donn√©es de la conf√©rence :

```diff
+use Symfony\Component\String\Slugger\SluggerInterface;

 #[ORM\Entity(repositoryClass: ConferenceRepository::class)]
 #[UniqueEntity('slug')]

@@ ...


+    public function computeSlug(SluggerInterface $slugger)
+    {
+        if (!$this->slug || '-' === $this->slug) {
+            $this->slug = (string) $slugger->slug((string) $this)->lower();
+        }
+    }
+
     public function getCity(): ?string
```

La m√©thode `computeSlug()` ne calcule un slug que lorsque le slug courant est vide ou d√©fini √† la valeur sp√©ciale -. Pourquoi avons-nous besoin de cette valeur particuli√®re - ? Parce que lors de l'ajout d'une conf√©rence dans l'interface d'administration, le slug est n√©cessaire. Nous avons donc besoin d'une valeur non vide qui indique √† l'application que nous voulons que le slug soit g√©n√©r√© automatiquement.
]
---

.left-column[
### A. √âcouter les √©v√©nements
### B. G√©rer le cycle de vie des objets Doctrine
#### D√©finir des lifecycle callbacks
#### Ajouter des slugs aux conf√©rences
#### D√©finir un lifecycle callback complexe
]
.right-column[
Comme pour la propri√©t√© createdAt, la propri√©t√© slug doit √™tre d√©finie automatiquement √† chaque fois que la conf√©rence est mise √† jour en appelant la m√©thode `computeSlug()`.

Mais comme cette m√©thode d√©pend d'une impl√©mentation de `SluggerInterface`, nous ne pouvons pas ajouter un √©v√©nement `prePersist` comme avant (nous n'avons pas la possibilit√© d'injecter le slugger).

Cr√©ez plut√¥t un listener d'entit√© Doctrine :
```php
# src/EntityListener/ConferenceEntityListener.php 
namespace App\EntityListener;

use App\Entity\Conference;
use Doctrine\ORM\Event\LifecycleEventArgs;
use Symfony\Component\String\Slugger\SluggerInterface;

class ConferenceEntityListener
{
    public function __construct(private SluggerInterface $slugger) { }

    public function prePersist(Conference $conference, LifecycleEventArgs $event)
    {
        $conference->computeSlug($this->slugger);
    }

    public function preUpdate(Conference $conference, LifecycleEventArgs $event)
    {
        $conference->computeSlug($this->slugger);
    }
}
```

Notez que le slug est modifi√© lorsqu'une nouvelle conf√©rence est cr√©√©e (`prePersist()`) et lorsqu'elle est mise √† jour (`preUpdate()`).
]
---

.left-column[
### A. √âcouter les √©v√©nements
### B. G√©rer le cycle de vie des objets Doctrine
#### D√©finir des lifecycle callbacks
#### Ajouter des slugs aux conf√©rences
#### D√©finir un lifecycle callback complexe
#### Configurer un service dans le conteneur
]
.right-column[
Jusqu'√† pr√©sent, nous n'avons pas parl√© d'un √©l√©ment cl√© de Symfony, *le conteneur d'injection de d√©pendance*. Le conteneur est responsable de la gestion des services : leur cr√©ation, et leur injection en cas de besoin.

Un service est un objet "global" qui fournit des fonctionnalit√©s (par exemple un mailer, un logger, un slugger, etc.) contrairement aux objets de donn√©es (par exemple les instances d'entit√©s Doctrine).

Vous interagissez rarement directement avec le conteneur car il injecte automatiquement des objets de service quand vous en avez besoin : par exemple, le conteneur injecte les objets en arguments du contr√¥leur lorsque vous les typez.

Si vous vous demandez comment le listener d'√©v√©nement a √©t√© initialis√© √† l'√©tape pr√©c√©dente, vous avez maintenant la r√©ponse : le conteneur. Lorsqu'une classe impl√©mente des interfaces sp√©cifiques, le conteneur sait que la classe doit √™tre initialis√©e d'une certaine mani√®re.

Dans ce cas pr√©cis, puisque notre classe n'impl√©mente aucune interface et n'√©tend aucune autre classe, Symfony ne peux pas la configurer automatiquement. Utilisons un attribut pour l'aider :
```diff
+use Doctrine\Bundle\DoctrineBundle\Attribute\AsEntityListener;
+use Doctrine\ORM\Events;

+#[AsEntityListener(event: Events::prePersist, entity: Conference::class)]
+#[AsEntityListener(event: Events::preUpdate, entity: Conference::class)]
 class ConferenceEntityListener
 {
```
> ‚ùó Ne confondez pas les listeners d'√©v√©nements Doctrine et ceux de Symfony. M√™me s'ils se ressemblent beaucoup, ils n'utilisent pas la m√™me infrastructure en interne.
]
---

.left-column[
### A. √âcouter les √©v√©nements
### B. G√©rer le cycle de vie des objets Doctrine
#### D√©finir des lifecycle callbacks
#### Ajouter des slugs aux conf√©rences
#### D√©finir un lifecycle callback complexe
#### Configurer un service dans le conteneur
#### Utiliser des slugs dans l'application
]
.right-column[
Essayez d'ajouter d'autres conf√©rences dans l'interface d'administration et changez la ville ou l'ann√©e d'une conf√©rence existante ; le slug ne sera pas mis √† jour sauf si vous utilisez la valeur sp√©ciale -.

La derni√®re modification consiste √† mettre √† jour les contr√¥leurs et les mod√®les pour utiliser le slug de la conf√©rence pour les routes, au lieu de son id :
```diff
# src/Controller/ConferenceController.php
-    #[Route('/conference/{id}', name: 'conference')]
+    #[Route('/conference/{slug}', name: 'conference')]
     public function show(Request $request, Conference $conference, CommentRepository $commentRepository): Response

# templates/base.html.twig
             {% for conference in conferences %}
-                <li><a href="{{ path('conference', { id: conference.id }) }}">{{ conference }}</a></li>
+                <li><a href="{{ path('conference', { slug: conference.slug }) }}">{{ conference }}</a></li>
             {% endfor %}

# templates/conference/index.html.twig  
         <p>
-            <a href="{{ path('conference', { id: conference.id }) }}">View</a>
+            <a href="{{ path('conference', { slug: conference.slug }) }}">View</a>
         </p>

# templates/conference/show.html.twig
         {% if previous >= 0 %}
-            <a href="{{ path('conference', { id: conference.id, offset: previous }) }}">Previous</a>
+            <a href="{{ path('conference', { slug: conference.slug, offset: previous }) }}">Previous</a>
         {% endif %}
         {% if next < comments|length %}
-            <a href="{{ path('conference', { id: conference.id, offset: next }) }}">Next</a>
+            <a href="{{ path('conference', { slug: conference.slug, offset: next }) }}">Next</a>
         {% endif %}
```
]
---

.left-column[
### A. √âcouter les √©v√©nements
### B. G√©rer le cycle de vie des objets Doctrine
#### D√©finir des lifecycle callbacks
#### Ajouter des slugs aux conf√©rences
#### D√©finir un lifecycle callback complexe
#### Configurer un service dans le conteneur
#### Utiliser des slugs dans l'application
]
.right-column[
L'acc√®s √† la page d'une conf√©rence devrait maintenant se faire gr√¢ce √† son slug :

.center[<img src="img/slug.png" alt="Slug" width="350px">]

  > üì¨ Commitez notre travail via `git commit -am "G√©rer le cycle de vie des objets Doctrine"`
]
---
class: center, middle, inverse
# 5. Les formulaires
---

.left-column[
  <br/>

#### G√©n√©rer un form type
]
.right-column[
Il est temps de permettre aux personnes pr√©sentes de donner leur avis sur les conf√©rences. Elles feront part de leurs commentaires au moyen d'un formulaire HTML.

Utilisez le Maker Bundle pour g√©n√©rer une classe de formulaire :

```sh
symfony console make:form CommentFormType Comment
```

La classe `App\Form\CommentFormType` √† √©t√© g√©n√©r√© et d√©finit un formulaire pour l'entit√© `App\Entity\Comment`

Un form type d√©crit les champs de formulaire li√©s √† un mod√®le. Il effectue la conversion des donn√©es entre les donn√©es soumises et les propri√©t√©s de la classe de mod√®le. Par d√©faut, Symfony utilise les m√©tadonn√©es de l'entit√© `Comment`, comme les m√©tadonn√©es Doctrine, pour deviner la configuration de chaque champ. Par exemple, le champ `text` se pr√©sente sous la forme d'un `textarea` parce qu'il utilise une colonne plus grande dans la base de donn√©es.
]
---

.left-column[
  <br/>

#### G√©n√©rer un form type
#### Afficher un formulaire
]
.right-column[
  Pour afficher le formulaire, cr√©ez-le dans le contr√¥leur et transmettez-le au template :

```diff
+use App\Entity\Comment;
 use App\Entity\Conference;
+use App\Form\CommentFormType;

@@ ...

     #[Route('/conference/{slug}', name: 'conference')]
     public function show(Request $request, Conference $conference, CommentRepository $commentRepository): Response
     {
+        $comment = new Comment();
+        $form = $this->createForm(CommentFormType::class, $comment);
+

@@ ...

             'previous' => $offset - CommentRepository::PAGINATOR_PER_PAGE,
             'next' => min(count($paginator), $offset + CommentRepository::PAGINATOR_PER_PAGE),
+            'comment_form' => $form,
```

Vous ne devriez jamais instancier directement le form type. Utilisez plut√¥t la m√©thode createForm(). Cette m√©thode fait partie d'AbstractController et facilite la cr√©ation de formulaires.

Lorsque vous transmettez un formulaire √† un template, utilisez createView() pour convertir les donn√©es dans un format adapt√© aux templates.
]
---

.left-column[
  <br/>

#### G√©n√©rer un form type
#### Afficher un formulaire
]
.right-column[
L'affichage du formulaire dans le template peut se faire via la fonction Twig form :
```diff
# templates/conference/show.html.twig
     {% endif %}
+
+    <h2>Add your own feedback</h2>
+
+    {{ form(comment_form) }}
 {% endblock %}
```

Lorsque vous rafra√Æchissez la page d'une conf√©rence dans le navigateur, notez que chaque champ de formulaire affiche la balise HTML appropri√©e (le type de donn√©es est d√©fini √† partir du mod√®le) :

.center[<img src="img/form.png" width="300px">]

La fonction `form()` g√©n√®re le formulaire HTML en fonction de toutes les informations d√©finies dans le form type. Elle ajoute √©galement `enctype=multipart/form-data` √† la balise `<form> `comme l'exige le champ d'upload de fichier. De plus, elle se charge d'afficher les messages d'erreur lorsque la soumission comporte des erreurs. Tout peut √™tre personnalis√© en rempla√ßant les templates par d√©faut, mais nous n'en aurons pas besoin pour ce projet.
]
---

.left-column[
  <br/>

#### G√©n√©rer un form type
#### Afficher un formulaire
#### Personnaliser un form type
]
.right-column[
M√™me si les champs de formulaire sont configur√©s en fonction de leur mod√®le associ√©, vous pouvez personnaliser la configuration par d√©faut directement dans la classe de form type :

```diff
 class CommentFormType extends AbstractType
 {
     public function buildForm(FormBuilderInterface $builder, array $options): void
     {
         $builder
-            ->add('author')
+            ->add('author', null, [
+                'label' => 'Your name',
+            ])
             ->add('text')
-            ->add('email')
-            ->add('createdAt')
-            ->add('photoFilename')
-            ->add('conference')
+            ->add('email', EmailType::class)
+            ->add('photo', FileType::class, [
+                'required' => false,
+                'mapped' => false,
+                'constraints' => [
+                    new Image(['maxSize' => '1024k'])
+                ],
+            ])
+            ->add('submit', SubmitType::class)
         ;
```
Notez que nous avons ajout√© un bouton submit (qui nous permet de continuer √† utiliser simplement {{ form(comment_form) }} dans le template).


]
---

.left-column[
  <br/>

#### G√©n√©rer un form type
#### Afficher un formulaire
#### Personnaliser un form type
]
.right-column[
Certains champs ne peuvent pas √™tre auto-configur√©s, comme par exemple photoFilename. L'entit√© Comment n'a besoin d'enregistrer que le nom du fichier photo, mais le formulaire doit s'occuper de l'upload du fichier lui-m√™me. Pour traiter ce cas, nous avons ajout√© un champ appel√© photo qui est un champ non mapped : il ne sera associ√© √† aucune propri√©t√© de Comment. Nous le g√©rerons manuellement pour impl√©menter une logique sp√©cifique (comme l'upload de la photo sur le disque).

Comme exemple de personnalisation, nous avons √©galement modifi√© le libell√© par d√©faut de certains champs.

.center[<img src="img/form-customized.png" width="400px">]
]
---

.left-column[
  <br/>

#### G√©n√©rer un form type
#### Afficher un formulaire
#### Personnaliser un form type
#### Valider des mod√®les
]
.right-column[
Le formulaire utilise le type de champ email pour l'email du commentaire et d√©finit la plupart des champs en required. Notez qu'il contient √©galement un champ _token cach√© pour nous prot√©ger des attaques CSRF.

Mais si la soumission du formulaire contourne la validation HTML (en utilisant un client HTTP comme cURL, qui n'applique pas ces r√®gles de validation), des donn√©es invalides peuvent atteindre le serveur.

Nous devons √©galement ajouter certaines contraintes de validation √† l'entit√© Comment :
```diff
 use Doctrine\ORM\Mapping as ORM;
+use Symfony\Component\Validator\Constraints as Assert;

@@ ....

+    #[Assert\NotBlank]
     private ?string $author = null;

     #[ORM\Column(type: Types::TEXT)]
+    #[Assert\NotBlank]
     private ?string $text = null;

     #[ORM\Column(length: 255)]
+    #[Assert\NotBlank]
+    #[Assert\Email]
     private ?string $email = null;
```
]
---

.left-column[
  <br/>

#### G√©n√©rer un form type
#### Afficher un formulaire
#### Personnaliser un form type
#### Valider des mod√®les
#### G√©rer un formulaire
]
.right-column[
Le code que nous avons √©crit jusqu'√† pr√©sent est suffisant pour afficher le formulaire.

Nous devrions maintenant nous occuper de la soumission du formulaire et de la persistance de ses informations dans la base de donn√©es depuis le contr√¥leur :

```diff
 class ConferenceController extends AbstractController
 {
+    public function __construct(private readonly EntityManagerInterface $entityManager) { }

@@ ...

         $form = $this->createForm(CommentFormType::class, $comment);
+        $form->handleRequest($request);
+        if ($form->isSubmitted() && $form->isValid()) {
+            $comment->setConference($conference);
+
+            $this->entityManager->persist($comment);
+            $this->entityManager->flush();
+
+            return $this->redirectToRoute('conference', ['slug' => $conference->getSlug()]);
+        }

```
Lorsque le formulaire est soumis, l'objet Comment est mis √† jour en fonction des donn√©es soumises.

La conf√©rence doit √™tre la m√™me que celle de l'URL (nous l'avons supprim√©e du formulaire).

Si le formulaire n'est pas valide, nous affichons la page, mais le formulaire contiendra maintenant les valeurs soumises et les messages d'erreur afin qu'ils puissent √™tre affich√©s √† l'internaute.

Essayez le formulaire. Il devrait fonctionner correctement et les donn√©es devraient √™tre stock√©es dans la base de donn√©es (v√©rifiez-les dans l'interface d'administration). Il y a cependant un probl√®me : les photos. Elles ne fonctionnent pas puisque nous ne les avons pas encore trait√©es dans le contr√¥leur.
]
---

.left-column[
  <br/>

#### G√©n√©rer un form type
#### Afficher un formulaire
#### Personnaliser un form type
#### Valider des mod√®les
#### G√©rer un formulaire
#### Uploader des fichiers
]
.right-column[
Les photos upload√©es doivent √™tre stock√©es sur le disque local, √† un endroit accessible par un navigateur afin que nous puissions les afficher sur la page d'une conf√©rence. Nous les stockerons dans le dossier public/uploads/photos :

Comme nous ne souhaitons pas mettre le r√©pertoire en dur dans le code, nous devons trouver un moyen de le stocker de fa√ßon globale. Le conteneur Symfony est capable de stocker des param√®tres (parameters) en plus des services pour permettre de les configurer :
```diff
# config/services.yaml
 parameters:
+    photo_dir: "%kernel.project_dir%/public/uploads/photos"
```
Nous avons d√©j√† vu comment les services sont automatiquement inject√©s dans les arguments des constructeurs. Pour les param√®tres du conteneur, nous pouvons les injecter explicitement en utilisant l'attribut `Autowire`.

Maintenant, nous avons tout ce qu'il nous faut pour impl√©menter la logique n√©cessaire au stockage du fichier soumis sous sa destination finale :

```diff
# src/Controller/ConferenceController.php
-    public function show(Request $request, Conference $conference, CommentRepository $commentRepository): Response
-    {
+    public function show(
+        Request $request,
+        Conference $conference,
+        CommentRepository $commentRepository,
+        #[Autowire('%photo_dir%')] string $photoDir,
+    ): Response {
```

]
---

.left-column[
  <br/>

#### G√©n√©rer un form type
#### Afficher un formulaire
#### Personnaliser un form type
#### Valider des mod√®les
#### G√©rer un formulaire
#### Uploader des fichiers
]
.right-column[
```diff
# src/Controller/ConferenceController.php

         if ($form->isSubmitted() && $form->isValid()) {
             $comment->setConference($conference);

+            if ($photo = $form['photo']->getData()) {
+                $filename = bin2hex(random_bytes(6)).'.'.$photo->guessExtension();
+                try {
+                    $photo->move($photoDir, $filename);
+                } catch (FileException $e) {
+                    // unable to upload the photo, give up
+                }
+                $comment->setPhotoFilename($filename);
+            }

             $this->entityManager->persist($comment);
             $this->entityManager->flush();
```

Pour g√©rer les uploads de photos, nous cr√©ons un nom al√©atoire pour le fichier. Ensuite, nous d√©pla√ßons le fichier upload√© √† son emplacement final (le r√©pertoire photo). Enfin, nous stockons le nom du fichier dans l'objet Comment.

Essayez d'uploader un fichier PDF au lieu d'une photo. Vous devriez voir les messages d'erreur en action. Le design est encore assez laid, mais ne vous inqui√©tez pas, tout deviendra beau en quelques √©tapes lorsque nous travaillerons dessus. Pour les formulaires, nous allons changer une ligne de configuration pour styliser tous leurs √©l√©ments.
]
---

.left-column[
  <br/>

#### G√©n√©rer un form type
#### Afficher un formulaire
#### Personnaliser un form type
#### Valider des mod√®les
#### G√©rer un formulaire
#### Uploader des fichiers
#### D√©boguer des formulaires
]
.right-column[
Lorsqu'un formulaire est soumis et que quelque chose ne fonctionne pas correctement, utilisez le panneau "Form" du Symfony Profiler. Il vous donne des informations sur le formulaire, toutes ses options, les donn√©es soumises et comment elles sont converties en interne. Si le formulaire contient des erreurs, elles seront √©galement r√©pertori√©es.

Le workflow classique d'un formulaire est le suivant :

* Le formulaire est affich√© sur une page ;
* L'internaute soumet le formulaire via une requ√™te POST ;
* Le serveur redirige l'internaute, soit vers une autre page, soit vers la m√™me page.

.pull-left[
Mais comment pouvez-vous acc√©der au profileur pour une requ√™te de soumission r√©ussie ? √âtant donn√© que la page est imm√©diatement redirig√©e, nous ne voyons jamais la barre d'outils de d√©bogage Web pour la requ√™te POST. 

Pas de probl√®me : sur la page redirig√©e, survolez la partie verte "200" √† gauche. Vous devriez voir la redirection "302" avec un lien vers le profileur (entre parenth√®ses).
]
.pull-right[
  .center[
    <img src="img/form-profiler.png" height="370px" />
  ]
]
]
---

.left-column[
  <br/>

#### G√©n√©rer un form type
#### Afficher un formulaire
#### Personnaliser un form type
#### Valider des mod√®les
#### G√©rer un formulaire
#### Uploader des fichiers
#### D√©boguer des formulaires
#### Afficher les photos upload√©es dans l'interface d'admin
]
.right-column[
#### Afficher les photos upload√©es dans l'interface d'admin

L'interface d'administration affiche actuellement le nom du fichier photo, mais nous voulons voir la vraie photo :
```diff
# src/Controller/Admin/CommentCrudController.php
 use EasyCorp\Bundle\EasyAdminBundle\Field\EmailField;
+use EasyCorp\Bundle\EasyAdminBundle\Field\ImageField;
 use EasyCorp\Bundle\EasyAdminBundle\Field\TextareaField;

 @@ ...

-        yield TextField::new('photoFilename')
+        yield ImageField::new('photoFilename')
+            ->setBasePath('/uploads/photos')
+            ->setLabel('Photo')
             ->onlyOnIndex()
         ;
```
#### Exclure les photos upload√©es de Git
Ne commitez pas encore ! Nous ne voulons pas stocker les images upload√©es dans le d√©p√¥t Git. Ajoutez le dossier /public/uploads au fichier .gitignore :
```diff
# .gitignore

+/public/uploads

 ###> symfony/framework-bundle ###
```

> üì¨ Commitez notre travail via `git commit -am "Formulaire"`
]

---
class: center, middle, inverse
# 6. S√©curit√©
---

.left-column[
### A. S√©curiser l'interface d'admin
#### D√©finir une entit√© User
]
.right-column[
L'interface d'administration ne doit √™tre accessible que par des personnes autoris√©es. La s√©curisation de cette zone du site peut se faire √† l'aide du composant Symfony Security.

#### D√©finir une entit√© User
M√™me si les internautes ne pourront pas cr√©er leur propre compte sur le site, nous allons cr√©er un syst√®me d'authentification enti√®rement fonctionnel pour l'admin. Nous n'aurons donc qu'un seul `User`, l'admin du site.

La premi√®re √©tape consiste √† d√©finir une entit√© `User`. Pour √©viter toute confusion, nommons-la plut√¥t Admin.

Pour utiliser l'entit√© *Admin* dans le syst√®me d'authentification de Symfony, celle-ci doit respecter certaines exigences sp√©cifiques. Par exemple, elle a besoin d'une propri√©t√© password.

Utilisez la commande d√©di√©e make:user pour cr√©er l'entit√© Admin au lieu de la commande traditionnelle `make:entity` :

```sh
symfony console make:user Admin
```

R√©pondez aux questions qui vous sont pos√©es : nous voulons utiliser Doctrine pour stocker nos users (yes), utiliser username pour le nom d'affichage unique des admins et chaque admin aura un mot de passe (yes).

La classe g√©n√©r√©e contient des m√©thodes comme `getRoles()`, `eraseCredentials()` et d'autres qui sont n√©cessaires au syst√®me d'authentification de Symfony.

Si vous voulez ajouter d'autres propri√©t√©s √† l'entit√© Admin, ex√©cutez `make:entity`.
]
---

.left-column[
### A. S√©curiser l'interface d'admin
#### D√©finir une entit√© User
]
.right-column[
Ajoutons une m√©thode `__toString()` et implementons `\Stringable` comme EasyAdmin les aime :
```diff
# src/Entity/Admin.php

+    public function __toString(): string
+    {
+        return $this->username;
+    }
```

En plus de g√©n√©rer l'entit√© Admin, la commande a √©galement mis √† jour la configuration de s√©curit√© pour connecter l'entit√© au syst√®me d'authentification :
```diff
# config/packages/security.yaml

     providers:
-        users_in_memory: { memory: null }
+        app_user_provider:
+            entity:
+                class: App\Entity\Admin
+                property: username
     firewalls:
         main:
             lazy: true
-            provider: users_in_memory
+            provider: app_user_provider
```
Nous laissons Symfony choisir le meilleur algorithme possible pour hacher les mots de passe (il √©voluera avec le temps).

Il est temps de g√©n√©rer une migration et de migrer la base de donn√©es :
]
---

.left-column[
### A. S√©curiser l'interface d'admin
#### D√©finir une entit√© User
#### G√©n√©rer un mot de passe pour l'admin
]
.right-column[
Nous ne d√©velopperons pas de syst√®me d√©di√© pour cr√©er des comptes d'administration. Encore une fois, nous n'aurons qu'un seul admin. Le login sera admin et nous devons g√©n√©rer le hash du mot de passe.

S√©lectionnez `App\Entity\Admin` et choisissez ce que vous voulez comme mot de passe et ex√©cutez la commande suivante pour g√©n√©rer le hash du mot de passe :

```sh
symfony console security:hash-password
```

Ins√©rez l'admin gr√¢ce √† une requ√™te SQL :
```sh
symfony run psql -c "INSERT INTO admin (id, username, roles, password) \
  VALUES (nextval('admin_id_seq'), 'admin', '[\"ROLE_ADMIN\"]', \
  '\$argon2id\$v=19\$m=65536,t=4,p=1\$BQG+jovPcunctc30xG5PxQ\$TiGbx451NKdo+g9vLtfkMy4KjASKSOcnNxjij4gTX1s')"
```

> ‚ùóNotez l'√©chappement du caract√®re `$` dans le mot de passe ; √©chappez tous les caract√®res qui en ont besoin !
]
---

.left-column[
### A. S√©curiser l'interface d'admin
#### D√©finir une entit√© User
#### G√©n√©rer un mot de passe pour l'admin
#### Configurer le syst√®me d'authentification
]
.right-column[
Maintenant que nous avons un admin, nous pouvons s√©curiser l'interface d'administration. Symfony accepte plusieurs strat√©gies d'authentification. Utilisons un classique syst√®me d'authentification par formulaire.

Ex√©cutez la commande make:auth pour mettre √† jour la configuration de s√©curit√©, g√©n√©rer un template pour la connexion et cr√©er une classe d'authentification (authenticator) :
```sh
symfony console make:auth
```

S√©lectionnez 1 pour g√©n√©rer une classe d'authentification pour le formulaire de connexion, nommez la classe d'authentification `AppAuthenticator`, le contr√¥leur `SecurityController` et cr√©ez une URL `/logout` (yes).

La commande a mis √† jour la configuration de s√©curit√© pour lier les classes g√©n√©r√©es :
```diff
# config/packages/security.yaml

         main:
             lazy: true
             provider: app_user_provider
+            custom_authenticator: App\Security\AppAuthenticator
+            logout:
+                path: app_logout
+                # where to redirect after logout
+                # target: app_any_route
```


]

---

.left-column[
### A. S√©curiser l'interface d'admin
#### D√©finir une entit√© User
#### G√©n√©rer un mot de passe pour l'admin
#### Configurer le syst√®me d'authentification
#### Ajouter les r√®gles de contr√¥le d'acc√®s
]
.right-column[
  
Comme l'indique la sortie de la commande, nous devons personnaliser la route dans la m√©thode `onAuthenticationSuccess()` pour rediriger l'admin lorsqu'il a r√©ussi √† se connecter :

```diff
# src/Security/AppAuthenticator.php

-        // For example:
-        // return new RedirectResponse($this->urlGenerator->generate('some_route'));
-        throw new \Exception('TODO: provide a valid redirect inside '.__FILE__);
+        return new RedirectResponse($this->urlGenerator->generate('admin'));
```
#### Ajouter les r√®gles de contr√¥le d'acc√®s
Un syst√®me de s√©curit√© se compose de deux parties : l'authentification et l'autorisation. Lors de la cr√©ation de l'admin, nous lui avons donn√© le r√¥le `ROLE_ADMIN`. Limitons la section `/admin` aux seules personnes ayant ce r√¥le en ajoutant une r√®gle √† `access_control` :

```diff
# config/packages/security.yaml

     access_control:
-        # - { path: ^/admin, roles: ROLE_ADMIN }
+        - { path: ^/admin, roles: ROLE_ADMIN }
```

Les r√®gles access_control limitent l'acc√®s par des expressions r√©guli√®res. Lorsqu'une personne connect√©e tente d'acc√©der √† une URL qui commence par `/admin`, le syst√®me de s√©curit√© v√©rifie qu'elle a bien le r√¥le `ROLE_ADMIN`.
]

---

.left-column[
### A. S√©curiser l'interface d'admin
#### D√©finir une entit√© User
#### G√©n√©rer un mot de passe pour l'admin
#### Configurer le syst√®me d'authentification
#### Ajouter les r√®gles de contr√¥le d'acc√®s
#### S'authentifier avec le formulaire de connexion
]
.right-column[
Si vous essayez d'acc√©der √† l'interface d'administration, vous devriez maintenant √™tre redirig√© vers la page de connexion et √™tre invit√© √† entrer un identifiant et un mot de passe :

.center[<img src="img/easy-admin-login.png" width="300px">]

Connectez-vous en utilisant `admin` et le mot de passe que vous avez choisi pr√©c√©demment. Si vous avez copi√© exactement ma requ√™te SQL, le mot de passe est `admin`.

Notez qu'EasyAdmin s'int√®gre automatiquement au syst√®me d'authentification de Symfony :

.center[<img src="img/easy-admin-secured.png" width="300px">]

> üóí Si vous voulez cr√©er un syst√®me complet d'authentification par formulaire, jetez un coup d‚Äô≈ìil √† la commande make:registration-form.
]

---

.left-column[
### A. S√©curiser l'interface d'admin
### B. Emp√™cher le spam avec une API
]
.right-column[
N'importe qui peut soumettre un commentaire, m√™me des robots ou des spammeurs. Nous pourrions ajouter un "captcha" au formulaire pour nous prot√©ger des robots, ou nous pouvons utiliser des API tierces.

J'ai d√©cid√© d'utiliser le service gratuit [Akismet](https://akismet.com/) pour montrer comment appeler une API et comment faire un appel "vers l'ext√©rieur".

#### S'inscrire sur Akismet
Cr√©ez un compte gratuit sur [akismet.com](https://akismet.com/) et r√©cup√©rez la cl√© de l'API Akismet.

#### Ajouter une d√©pendance au composant Symfony HTTPClient
Au lieu d'utiliser une biblioth√®que qui abstrait l'API d'Akismet, nous ferons directement tous les appels API. Faire nous-m√™mes les appels HTTP est plus efficace (et nous permet de b√©n√©ficier de tous les outils de d√©bogage de Symfony comme l'int√©gration avec le Symfony Profiler).

#### Concevoir une classe de v√©rification de spam

Cr√©ez une nouvelle classe dans src/ nomm√©e SpamChecker pour contenir la logique d'appel √† l'API d'Akismet et l'interpr√©tation de ses r√©ponses :
]

---

.left-column[
### A. S√©curiser l'interface d'admin
### B. Emp√™cher le spam avec une API
]
.right-column[
```php
namespace App;

use App\Entity\Comment;
use Symfony\Contracts\HttpClient\HttpClientInterface;

class SpamChecker
{
    private $endpoint;

    public function __construct(private HttpClientInterface $client, string $akismetKey,) 
    {
        $this->endpoint = sprintf('https://%s.rest.akismet.com/1.1/comment-check', $akismetKey);
    }

    /**
     * @return int Spam score: 0: not spam, 1: maybe spam, 2: blatant spam
     */
    public function getSpamScore(Comment $comment, array $context): int
    {
        $response = $this->client->request('POST', $this->endpoint, [
            'body' => array_merge($context, [
                'blog' => 'https://guestbook.example.com',
                'comment_type' => 'comment',
                'comment_author' => $comment->getAuthor(),
                'comment_author_email' => $comment->getEmail(),
                'comment_content' => $comment->getText(),
                'comment_date_gmt' => $comment->getCreatedAt()->format('c'),
                'blog_lang' => 'en',
                'blog_charset' => 'UTF-8',
                'is_test' => true,
            ]),
        ]);

        $headers = $response->getHeaders();
        if ('discard' === ($headers['x-akismet-pro-tip'][0] ?? '')) {
            return 2;
        }

        $content = $response->getContent();
        if (isset($headers['x-akismet-debug-help'][0])) {
            throw new \RuntimeException(sprintf('Unable to check for spam: %s (%s).', $content, $headers['x-akismet-debug-help'][0]));
        }

        return 'true' === $content ? 1 : 0;
    }
}
```
]

