name: inverse
class: center, middle, inverse
# Api Platform
<br />
<img src="img/logo.png" alt="Api Plateform" />
<br />
<div class="logo"><svg class="logo-1" fill="white" width="196" height="64" viewBox="0 0 196 64" style="fill-rule: evenodd; clip-rule: evenodd; stroke-linejoin: round; stroke-miterlimit: 2;"><g transform="matrix(0.101031,0,0,0.101031,2.39526,-0.329946)"><g transform="matrix(1.27705,0,0,1.27705,1143.65,155.404)"><path d="M320.958,94.576C320.958,107.301 317.357,117.884 310.155,126.323C302.952,134.763 293.386,140.971 281.456,144.947L331.695,223.685L290.072,223.685L246.727,150.647L230.025,150.647L230.025,223.685L193.837,223.685L193.837,40.361L247.787,40.361C296.568,40.361 320.958,58.433 320.958,94.576ZM283.312,94.576C283.312,84.855 280.462,77.764 274.762,73.301C269.062,68.838 260.38,66.607 248.715,66.607L230.025,66.607L230.025,124.931L249.908,124.931C260.954,124.931 269.283,122.501 274.895,117.641C280.506,112.78 283.312,105.092 283.312,94.576Z" style="fill-rule: nonzero;"></path></g><g transform="matrix(1.27705,0,0,1.27705,1486.87,208.548)"><path d="M313.005,64.751L241.159,227.264L208.153,217.058L277.612,67.402L195.163,67.402L195.163,40.361L313.005,40.361L313.005,64.751Z" style="fill-rule: nonzero;"></path></g><g transform="matrix(1.27705,0,0,1.27705,1335.53,155.404)"><path d="M253.752,12.524C257.994,12.524 261.75,13.43 265.019,15.241C268.289,17.053 270.852,19.55 272.708,22.731C274.563,25.912 275.491,29.447 275.491,33.335C275.491,37.224 274.563,40.758 272.708,43.94C270.852,47.121 268.289,49.64 265.019,51.495C261.75,53.351 257.994,54.279 253.752,54.279C249.51,54.279 245.733,53.351 242.419,51.495C239.105,49.64 236.52,47.121 234.664,[ ](https://poki.com/fr/g/snake-is-mlg-edition)43.94C232.808,40.758 231.88,37.224 231.88,33.335C231.88,29.447 232.808,25.912 234.664,22.731C236.52,19.55 239.105,17.053 242.419,15.241C245.733,13.43 249.51,12.524 253.752,12.524ZM201.658,83.309L276.419,83.309L276.419,198.897L313.402,198.897L313.402,223.685L200.332,223.685L200.332,198.897L241.424,198.897L241.424,108.097L201.658,108.097L201.658,83.309Z" style="fill-rule: nonzero;"></path></g><g transform="matrix(2.01117,0,0,2.01117,165.834,-128.735)"><path d="M261.043,177.319L211.622,177.319L211.622,218.681L254.382,218.681L254.382,228.302L211.622,228.302L211.622,271.803L264.332,271.803L264.332,280.93L201.096,280.93L201.096,167.944L262.441,167.944L261.043,177.319ZM213.76,150.758L245.501,134.23L250.682,143.851L216.72,156.432L213.76,150.758Z" style="fill-rule: nonzero;"></path></g><g transform="matrix(2.01117,0,0,2.01117,165.834,-128.735)"><path d="M312.861,273.201C321.248,273.201 329.06,270.651 336.297,265.553L341.642,272.46C337.969,275.53 333.501,277.984 328.238,279.82C322.975,281.657 317.987,282.575 313.272,282.575C304.994,282.575 297.922,280.766 292.056,277.148C286.191,273.529 281.723,268.376 278.653,261.688C275.583,255 274.048,247.133 274.048,238.088C274.048,229.426 275.583,221.696 278.653,214.898C281.723,208.101 286.218,202.756 292.139,198.863C298.059,194.971 305.131,193.025 313.354,193.025C323.935,193.025 333.282,196.287 341.395,202.81L335.968,210.129C328.128,204.757 320.426,202.07 312.861,202.07C307.488,202.07 302.733,203.441 298.594,206.182C294.455,208.923 291.22,212.993 288.89,218.393C286.561,223.793 285.396,230.358 285.396,238.088C285.396,245.927 286.547,252.465 288.849,257.7C291.152,262.935 294.373,266.828 298.512,269.377C302.65,271.926 307.434,273.201 312.861,273.201Z" style="fill-rule: nonzero;"></path></g><g transform="matrix(2.01117,0,0,2.01117,165.834,-128.735)"><path d="M386.388,193.025C394.118,193.025 400.641,194.834 405.959,198.452C411.277,202.07 415.251,207.224 417.883,213.912C420.514,220.6 421.83,228.549 421.83,237.759C421.83,246.421 420.473,254.137 417.759,260.907C415.046,267.677 411.003,272.981 405.63,276.819C400.258,280.656 393.761,282.575 386.141,282.575C378.412,282.575 371.874,280.725 366.529,277.024C361.184,273.324 357.168,268.13 354.482,261.441C351.796,254.753 350.453,246.914 350.453,237.923C350.453,228.987 351.81,221.148 354.523,214.405C357.237,207.662 361.294,202.413 366.694,198.658C372.093,194.903 378.658,193.025 386.388,193.025ZM386.388,201.988C369.887,201.988 361.636,213.967 361.636,237.923C361.636,261.661 369.805,273.529 386.141,273.529C402.478,273.529 410.646,261.606 410.646,237.759C410.646,213.912 402.56,201.988 386.388,201.988Z" style="fill-rule: nonzero;"></path></g><g transform="matrix(2.01117,0,0,2.01117,165.834,-128.735)"><path d="M463.945,261.359C463.945,265.635 465.301,268.76 468.015,270.734C470.729,272.707 474.443,273.694 479.157,273.694C483.982,273.694 489.053,272.652 494.37,270.569L497.33,278.463C494.973,279.669 492.136,280.656 488.82,281.424C485.503,282.191 481.953,282.575 478.171,282.575C473.566,282.575 469.413,281.739 465.713,280.067C462.012,278.395 459.093,275.955 456.955,272.748C454.817,269.541 453.748,265.745 453.748,261.359L453.748,168.52L426.94,168.52L426.94,159.639L463.945,159.639L463.945,261.359Z" style="fill-rule: nonzero;"></path></g><g transform="matrix(2.01117,0,0,2.01117,165.834,-128.735)"><path d="M520.121,241.87C520.231,248.833 521.491,254.657 523.904,259.345C526.316,264.032 529.509,267.513 533.483,269.788C537.458,272.063 541.885,273.201 546.764,273.201C551.15,273.201 555.11,272.57 558.646,271.309C562.182,270.048 565.979,268.02 570.035,265.224L575.38,272.872C571.433,275.942 566.952,278.326 561.936,280.026C556.919,281.725 551.999,282.575 547.175,282.575C539.336,282.575 532.552,280.725 526.823,277.024C521.094,273.324 516.722,268.102 513.707,261.359C510.692,254.616 509.184,246.777 509.184,237.841C509.184,229.125 510.705,221.381 513.748,214.611C516.791,207.84 521.08,202.55 526.617,198.74C532.154,194.93 538.486,193.025 545.613,193.025C552.52,193.025 558.496,194.711 563.539,198.082C568.583,201.454 572.434,206.278 575.093,212.555C577.751,218.832 579.081,226.246 579.081,234.798C579.081,236.059 578.999,238.417 578.834,241.87L520.121,241.87ZM545.859,202.564C541.09,202.564 536.855,203.674 533.155,205.894C529.454,208.114 526.48,211.472 524.232,215.967C521.985,220.463 520.669,226.027 520.285,232.66L569.377,232.66C569.158,222.793 566.938,215.31 562.717,210.211C558.496,205.113 552.876,202.564 545.859,202.564Z" style="fill-rule: nonzero;"></path></g><path d="M250.428,75.558C385.339,75.558 494.87,185.089 494.87,320C494.87,454.911 385.339,564.442 250.428,564.442C115.517,564.442 5.986,454.911 5.986,320C5.986,185.089 115.517,75.558 250.428,75.558ZM131.233,450.023L131.233,203.31L220.202,205.493C297.709,207.676 311.355,209.314 331.55,219.685C400.87,255.709 417.79,343.587 365.937,402.536L344.65,426.552L356.658,438.014L368.12,450.023L256.772,450.023L256.772,339.22L269.872,351.228L282.972,363.782L294.434,352.32C308.08,338.674 309.171,325.575 297.163,309.2C294.835,305.797 292.624,303.334 289.625,301.561C283.483,297.931 274.034,297.192 253.497,297.192L218.564,297.192L218.564,450.023L131.233,450.023Z"></path></g></svg></div>

---

class: middle
.left-column[
### Programme
]
.right-column[
1. **Introduction √† API Platform :** 
<br />pr√©sentation de l'outil, de ses fonctionnalit√©s et de son √©cosyst√®me.

2. **Installation et configuration de l'environnement de d√©veloppement :**
<br />installation de Symfony, configuration de l'environnement de d√©veloppement, installation de API Platform via Composer.

3. **Cr√©ation d'une premi√®re API :** 
<br />cr√©ation d'une entit√©, d√©finition de la ressource API, gestion des op√©rations CRUD.

4. **Pagination, filtrage et tri :** 
<br />mise en place de la pagination, du filtrage et du tri des r√©sultats.

5. **S√©rialisation et d√©s√©rialisation des donn√©es :** 
<br />d√©finition des groupes de s√©rialisation, gestion des relations entre les entit√©s, utilisation de formats de donn√©es alternatifs (XML, CSV, etc.).

6. **Authentification et autorisation :**
<br />configuration de l'authentification et de l'autorisation, utilisation de JWT et de OAuth2.

7. **Validation des donn√©es :** 
<br />validation des donn√©es entrantes, gestion des erreurs et des messages d'erreur.

8. **Relations entre les entit√©s :**
<br />d√©finition des relations entre les entit√©s, gestion de la navigation entre les ressources li√©es.

9. **Utilisation de GraphQL :**
<br />configuration de GraphQL dans API Platform, d√©finition des types de ressources, utilisation de l'API GraphQL.
]

---
class: middle, inverse, center

# 1. L'introduction √† API Platform

---

class: middle
L'introduction √† **API Platform** vise √† fournir une vue d'ensemble de l'outil, de ses fonctionnalit√©s et de son √©cosyst√®me.

#### 1. Qu'est-ce que API Platform ?
API Platform est un **framework PHP open source bas√© sur Symfony**, qui permet de cr√©er des API REST et des applications web modernes. Il offre une approche pragmatique pour cr√©er des API web s√©curis√©es, performantes et √©volutives.

#### 2. Les fonctionnalit√©s d'API Platform
API Platform est livr√© avec une large gamme de fonctionnalit√©s, y compris :

* La g√©n√©ration automatique de la documentation Swagger et ReDoc pour votre API

* Le support de formats de donn√©es vari√©s (JSON-LD, HAL, Hydra, etc.)

* Le support de multiples formats de requ√™tes (CRUD, filtres, pagination, tri, etc.)

* L'authentification et l'autorisation avec OAuth2 et JWT

* La validation automatique des donn√©es entrantes et des r√©ponses sortantes

* La personnalisation de l'interface d'administration avec EasyAdmin 

* L'optimisation des performances avec le cache de doctrine et le HTTP/2 Push

* La prise en charge de GraphQL

---
class: middle
####¬†L'√©cosyst√®me d'API Platform
API Platform s'int√®gre facilement avec de nombreux autres outils et technologies, tels que :

* **Symfony :** API Platform est construit sur Symfony, donc il est compatible avec toutes les fonctionnalit√©s de Symfony.

* **Doctrine :** API Platform utilise Doctrine pour la gestion de la base de donn√©es, ce qui facilite la cr√©ation et la manipulation des entit√©s.

* **React et Angular :** API Platform offre une compatibilit√© pr√™te √† l'emploi avec les biblioth√®ques React et Angular, ce qui facilite la cr√©ation d'applications web modernes.

* **Docker :** API Platform peut facilement √™tre int√©gr√© dans des environnements Dockeris√©s pour la production.

En r√©sum√©, API Platform est un outil puissant et flexible pour la cr√©ation d'API REST modernes. 

Avec ses fonctionnalit√©s riches et son √©cosyst√®me √©tendu, il est facile de d√©marrer rapidement avec API Platform pour cr√©er des applications web s√©curis√©es, performantes et √©volutives.

---
class: middle, inverse, center
# 2. Installation et configuration de l'environnement de d√©veloppement

---
class: middle

#### Installation de Symfony

Pour commencer avec API Platform, il est n√©cessaire d'installer Symfony. Symfony est un framework PHP qui fournit un ensemble de composants pour construire des applications web modernes.

Durant cette formation nous allons utiliser Gitpod pour installer Symfony, il suffit de fork le repo suivant : https://github.com/mkl-devops-ri7/formation-api-plateform

Suivons les √©tapes du README.md, l'installation de symfony se fera automatiquement et lancera le projet sur le port `8080`.

#### Configuration de l'environnement de d√©veloppement

Une fois Symfony install√©, il est recommand√© de configurer l'environnement de d√©veloppement. Il est possible de cr√©er un fichier `.env.local` √† la racine du projet pour stocker les variables d'environnement sp√©cifiques au d√©veloppement.

Dans ce fichier, vous pouvez d√©finir des param√®tres tels que la configuration de la base de donn√©es, les informations d'identification de l'API, etc.

Nous utiliserons Sqlite comme base de donn√©es lors de cette formation. Dans un nouveau fichier `.env.local` ajoutez-y le code suivant.
```dotenv
# .env
DATABASE_URL="sqlite:///%kernel.project_dir%/var/data.db"
```

---
class: middle

#### Installation de API Platform via Composer

Une fois que Symfony est install√© et configur√©, connectez-vous au container via `make docker-sh`.

Vous pouvez installer API Platform en utilisant **Composer**. API Platform est disponible sous forme de paquet Composer, qui peut √™tre install√© en utilisant la commande suivante :

```bash
symfony composer require api
```

Cette commande a installer tous les composants n√©cessaires pour utiliser API Platform dans votre projet Symfony, y compris la **documentation Swagger**, la prise en charge de **JSON-LD** et de **HAL**, et les composants pour la **validation**, la **pagination**, le **tri** et le **filtrage**.

ü™Ñ Api Platform est install√© vous pouvez vous rendre sur `/api`. Vous √™tes pr√™t √† commencer √† d√©velopper des API REST modernes avec API Platform.

.center[
  <img src="img/api-platform-doc-page.png" alt="Api Platform doc page" width="400" />
]

---

class: middle, inverse, center
# 3. Cr√©ation d'une premi√®re API

---

class: middle
#### Cr√©ation d'une entit√©

Pour cr√©er une API avec API Platform, vous devez d'abord cr√©er une entit√©. Les entit√©s sont des objets qui repr√©sentent des donn√©es que vous souhaitez stocker dans votre base de donn√©es. 

Par exemple, si vous cr√©ez une application de gestion de biblioth√®que, vous pourriez cr√©er une entit√© "`Book`" pour stocker les informations sur les livres.

Pour cr√©er une entit√© avec Symfony, vous pouvez utiliser la commande `make:entity`. Par exemple, pour cr√©er une entit√© "`Book`", vous pouvez ex√©cuter la commande suivante :
  
```bash
symfony console make:entity Book
```

Cette commande va cr√©er une classe `Book` dans le dossier `src/Entity`. D√©finissez les propri√©tes suivantes:

* `title`, `string`, `255`, `no` 
* `author`, `string`, `255`, `no`
* `year`, `string`, `4`, `yes`

G√©nerer le fichier de migration, puis l'appliquer

```bash
symfony console make:migration
symfony console doctrine:migrations:migrate
```

---
class: middle

#### D√©finition de la ressource API

Une fois que l'entit√© est cr√©√©e, il est temps de d√©finir la ressource API correspondante pour cette entit√©. Vous pouvez le faire en ajoutant des annotations √† la classe entit√©. Dans cet exemple, nous avons utilis√© l'attribute `#[ApiResource]` pour d√©finir la ressource API pour l'entit√© `Book`.

```diff
  <?php

  namespace App\Entity;

+ use ApiPlatform\Metadata\ApiResource;
  use App\Repository\BookRepository;
  use Doctrine\ORM\Mapping as ORM;

+ #[ApiResource]
  #[ORM\Entity(repositoryClass: BookRepository::class)]
  class Book
  {
    ...
  }
```

API Platform utilisera cette attribute pour g√©n√©rer automatiquement une API CRUD compl√®te pour votre entit√©.

Cela signifie que les op√©rations **CRUD** (Create, Read, Update, Delete) seront disponibles pour la ressource API.

.center[
  <img src="img/api-platform-doc-book.png" alt="Api Platform doc page" width="350" />
]

---
class: middle
#### Gestion des op√©rations CRUD

Avec la ressource API d√©finie, API Platform g√©n√©rera automatiquement les op√©rations CRUD correspondantes pour la ressource. Par exemple, vous pouvez envoyer une requ√™te `POST` pour cr√©er un nouveau livre via un curl dans le container :

```bash
curl -X POST "http://localhost:80/api/books" \
  -H "Content-Type: application/json" \
  -d '{"title": "The Hitchhikers Guide to the Galaxy", "author": "Douglas Adams", "year": "1979"}'
```

ou par la page de documentation swagger `/api` :

```json
{
  "title": "The Hitchhikers Guide to the Galaxy",
  "author": "Douglas Adams",
  "year": "1979"
}
```

API Platform effectuera la validation des donn√©es entrantes et cr√©era un nouveau livre dans la base de donn√©es.

Vous pouvez √©galement envoyer une requ√™te `GET` pour r√©cup√©rer une liste de livres :
  
```bash
curl -X GET "http://localhost:80/api/books" \
  -H "Content-Type: application/json"
```

API Platform retournera une liste de tous les livres disponibles dans la base de donn√©es.

---
class: middle, inverse, center
# 4. Pagination, filtrage et tri
---

class: middle
#### Pagination

La pagination est une technique permettant de limiter le nombre de r√©sultats renvoy√©s par une requ√™te et de fournir des liens pour acc√©der aux pages suivantes ou pr√©c√©dentes. 

API Platform prend en charge les collections pagin√©es en mode natif. La pagination est activ√©e par d√©faut pour toutes les collections. Chaque collection contient 30 √©l√©ments par page. L'activation de la pagination et le nombre d'√©l√©ments par page peuvent √™tre configur√©s.

* **Elle peut √™tre d√©sactiv√©e via l'option** `#[ApiResource(paginationEnabled: false)]`

* **Le nombre de r√©sulat par page peut-√™tre modifi√© via l'option** `#[ApiResource(paginationItemsPerPage: 10)]`
* **Le nombre maximul de r√©sulat peut-√™tre modifi√© via l'option** `#[ApiResource(paginationMaximumItemsPerPage: 100)]`

Dans ces exemples nous avons comment g√©rer la configuration depuis notre projet symfony. Vous pouvez aussi activer la r√©cup√©ration des r√©sultats pagin√©s en envoyant une requ√™te `GET` avec le param√®tres `itemsPerPage`:

```php
#[ApiResource(paginationClientItemsPerPage: true)]
```

```sh
curl -X GET "http://localhost:80/api/books?itemsPerPage=10" -H "Content-Type: application/json"
```

---

class: middle

#### Filtrage

Le filtrage permet de limiter les r√©sultats renvoy√©s par une requ√™te en fonction de crit√®res sp√©cifiques. Pour activer le filtrage dans API Platform, vous pouvez utiliser l'annotation `#[ApiFilter]`.

Par exemple, si vous souhaitez filtrer les livres en fonction de leur titre, vous pouvez ajouter l'attribute suivante √† la classe Livre :

```diff
  <?php

  namespace App\Entity;

+ use ApiPlatform\Doctrine\Orm\Filter\SearchFilter;
+ use ApiPlatform\Metadata\ApiFilter;
  use ApiPlatform\Metadata\ApiResource;
  use App\Repository\BookRepository;
  use Doctrine\ORM\Mapping as ORM;

  #[ApiResource]
+ #[ApiFilter(SearchFilter::class, properties: ['title' => 'partial'])]
  #[ORM\Entity(repositoryClass: BookRepository::class)]
  class Book
  {
    ...
  }
```

Dans cet exemple, nous avons utilis√© le filtre `SearchFilter` pour permettre le filtrage sur le champ `title` des livres. Le param√®tre partial indique que la recherche sera partielle, c'est-√†-dire que les r√©sultats incluront tous les livres dont le titre contient la valeur de recherche. Vous pouvez maintenant envoyer une requ√™te `GET` avec le param√®tre `title` pour filtrer les r√©sultats en fonction du titre :
  
  ```bash
  curl -X GET "http://localhost:80/api/books?title=Hitchhikers" \
    -H "Content-Type: application/json"
  ```

---
class: middle

#### Tri

Le tri permet de trier les r√©sultats renvoy√©s par une requ√™te en fonction d'un ou plusieurs crit√®res. Pour activer le tri dans API Platform, vous pouvez utiliser l'attribute `#[ApiFilter]`. Par exemple, si vous souhaitez trier les livres en fonction de leur titre, vous pouvez ajouter l'attribute suivante √† la classe `Book` :
  
```diff
  ...

+ use ApiPlatform\Doctrine\Orm\Filter\OrderFilter;
  use App\Repository\BookRepository;
  use Doctrine\ORM\Mapping as ORM;

  #[ApiResource]
  #[ApiFilter(SearchFilter::class, properties: ['title' => 'partial'])]
+ #[ApiFilter(OrderFilter::class, properties: ['title'])]
  #[ORM\Entity(repositoryClass: BookRepository::class)]
  class Book
  {
    ...
  }
```

Dans cet exemple, nous avons utilis√© le filtre `OrderFilter` pour permettre le tri sur le champ `title` des livres. Vous pouvez maintenant envoyer une requ√™te GET avec le param√®tre order pour trier les r√©sultats en fonction du titre :

```bash
curl -X GET "http://localhost:80/api/books?order%5Btitle%5D=asc" \
  -H "Content-Type: application/json"
```

Dans cet exemple, nous avons tri√© les r√©sultats par ordre croissant (`asc`) du champ `title`. Vous pouvez √©galement trier par ordre d√©croissant en utilisant la valeur `desc`.